---
title: "Analysis of ESPRESSO data (Stable 13.12.2015)"
author: "Your Name Goes Here"
output: rmarkdown::tufte_handout
---

# Introduction

*Describe your hypothesis and experimental details here.*

```{r setVariables, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
h <- 7 # Duration of experiment, IN HOURS. Change this if you just want to analyse, say, the first 3 hours.
bs <- 300 # Bin size of combined density raster plot, in seconds. Anywhere between 5 min (300s) and 10 min (600s) seems to be good.
bw <- 600 # Bin-sizes of time-course in seconds (s). Change here to change the bin size. (600s = 10 min)

file.path <- c("/home/amnesiac/data/pam.neurons.feeding/test2")
# Local file directory path name where data files are stored.
```

```{r installPackages, message = FALSE, error=FALSE, echo = FALSE, eval = FALSE}
# For data manipulation 
install.packages("dplyr")
install.packages("tidyr")
install.packages("data.table")
install.packages("lazyeval")

# For date-time manipulation
install.packages("lubridate")

# For running Dunn's Test
install.packages("dunn.test")

# For calculation of Hedges' g
install.packages("metafor") 

# To calculate 95% CIs by bootstrapping
install.packages("boot")

# For nice graphs.
install.packages("grid")
install.packages("gtable")
install.packages("ggplot2")
install.packages("gridExtra")
install.packages("cowplot")
install.packages("Rmisc")
devtools::install_github("eclarke/ggbeeswarm")

# To grab data from Google Sheets
install.packages("mosaic")

# In case I need to standardise colours across different graphs
install.packages("RColorBrewer")

# In case I want pretty tables.
install.packages("xtable")
```

```{r LoadLibraries, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
# For running Dunn's Test
library("dunn.test")

# For calculation of Hedges' g
library("metafor") 

# To calculate 95% CIs by bootstrapping
# library("boot")

# For nice graphs.
library("grid")
library("gtable")
library("ggplot2")
library("gridExtra")
library("cowplot")
library("Rmisc")
library("ggbeeswarm")
library("scales")

# To grab data from Google Sheets
library("mosaic")

# In case I need to standardise colours across different graphs
library("RColorBrewer")

# In case I want pretty tables.
library("xtable")
options(xtable.comment = FALSE)
options(xtable.booktabs = TRUE)

# For data manipulation 
library("dplyr") # Load AFTER plyr!!
library("tidyr")
library("data.table")
library("lazyeval")

# For date-time maniuplation
library("lubridate")

# load("~/baseLoad.RData") 
```

```{r defFunctions, message = FALSE, error=FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
# See http://stackoverflow.com/questions/12539348/ggplot-separate-legend-and-plot
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

# Code from https://zachexchange.wordpress.com/2013/08/03/binning-observations-r-or-creating-a-time-series-of-counts/
get.bin.counts = function(x, name.x = "x", start.pt, end.pt, bin.width) {
  br.pts = seq(start.pt, end.pt, bin.width)
  x = x[(x >= start.pt)&(x <= end.pt)]
  counts = hist(x, breaks = br.pts, plot = FALSE)$counts
  dfm = data.frame(br.pts[-length(br.pts)], counts)
  names(dfm) = c(name.x, "freq")
  return(dfm)
}

pi.calc <- function(v) {
  v <- as.numeric(v)
  sum <- sum(v)
  diff <- v[2] - v[1]
  pi <- diff/sum
  return(pi)
}

mean_se_paste <- function(v) {
  v <- as.numeric(v)
  a <- mean_se(v, mult = 1.96)
  aa <- unlist(unname(a))
  return(paste(aa, collapse = ","))
}

average <- function(data, i) { 
  a <- data[i] 
  return(mean(a))}
# To use:
# x <- boot(z, average, R = 200)
# xx <- boot.ci(x)

# Remove whitespace, from http://stackoverflow.com/questions/2261079/how-to-trim-leading-and-trailing-whitespace-in-r
# trim <- function (x) gsub("^\\s+|\\s+$", "", x)
```

# Results 

```{r LoadData, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
feedlog.path <- paste(file.path, "/feedlog", sep = "")
metadata.path <- paste(file.path, "/metadata", sep = "")
output.path <- paste(file.path, "/output_", format(Sys.time(), "%Y-%m-%d_%H.%M.%S"), sep = "")
dir.create(output.path) # Creates an output folder in home directory.

feedlog.list <- lapply(list.files(path = feedlog.path, full.names = T), FUN = read.csv)
names(feedlog.list) <- list.files(path = feedlog.path)
metadata.list <- lapply(list.files(path = metadata.path, full.names = T), FUN = read.csv)
names(metadata.list) <- list.files(path = metadata.path)

# Check if need to use csv2
for (i in 1:length(feedlog.list)) {
  if (ncol(feedlog.list[[i]]) == 1 ) {
    feedlog.list <- lapply(list.files(path = feedlog.path, full.names = T), FUN = read.csv2)
  }
}

for (i in 1:length(metadata.list)) {
  if (ncol(metadata.list[[i]]) == 1 ) {
    metadata.list <- lapply(list.files(path = metadata.path, full.names = T), FUN = read.csv2)
  }
}
```

```{r CalculateRelativeTimeCombineFeedLog, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
for (i in 1:length(feedlog.list)) {
  
  # Handle StartTime
  feedlog.list[[i]][, "StartTime"] <- as.character(feedlog.list[[i]][, "StartTime"])
  feedlog.list[[i]][, "StartTime"] <- parse_date_time(feedlog.list[[i]][, "StartTime"], "%d/%m/%Y %H:%M:%S", tz = "")
  
  # Add 1 to each FlyID, to match up with metadata.
  feedlog.list[[i]][, "FlyID"] <- feedlog.list[[i]][, "FlyID"] + 1
  # Then add previous number of flies from last logfile to avoid overlap of FlyIDs.
  if (i > 1) {
    feedlog.list[[i]][, "FlyID"] <- 
      feedlog.list[[i]][, "FlyID"] + 
      range(feedlog.list[[i - 1]][, "FlyID"])[2]
  }
  
  # Check if "Valid", "RelativeTime.s", and "ExperimentState" are columns.
  new.cols <- c("Valid","RelativeTime.s","ExperimentState")
  for (c in new.cols) {
    if ( !c %in% colnames(feedlog.list[[i]]) ) {
      feedlog.list[[i]][, c] <- rep(NA , nrow(feedlog.list[[i]]))
    }
  }
  
  if ( is.na(feedlog.list[[i]][1, "RelativeTime.s"]) ) {
    
    # Read in AssayStartTimeAbsolute from the filename
    filename <- list.files(feedlog.path)[i]
    s <- unlist(strsplit(filename, "\\_")) # The '\' in front of the separater ensure a regular expression is used.
    AssayStartTimeAbsolute <- paste(s[2], s[3], sep = " ")
    AssayStartTimeAbsolute <- parse_date_time(AssayStartTimeAbsolute, "%Y-%m-%d %H-%M-%S", tz = "")
    
    if (is.na(AssayStartTimeAbsolute)) {
      stop( paste("Check the filename for the feedlog file ", names(feedlog.list)[i], 
                  " Please make sure that the date is in YYYY-mm-dd format,",
                  " and that the time is in hh-mm-ss format,",
                  " and BOTH date and time MUST be flanked by underscores ' _ '.", sep = "") )
    }
    
    # time.vector <- rep(AssayStartTimeAbsolute, nrow(feedlog.list[[i]]))
    # Obtain FeedStartTimeRelative (relative to Assay Start Time, which is t = 0.)
    feedlog.list[[i]][, "RelativeTime.s"] <- feedlog.list[[i]][, "StartTime"] - AssayStartTimeAbsolute
    
    if ( length(feedlog.list[[i]][, "RelativeTime.s"][is.na(feedlog.list[[i]][, "RelativeTime.s"])]) > 0) {
      stop("FeedStartTimeRelative not being calculated correctly. Check the format of the StartTime column.")
      
    }
    if ( range(feedlog.list[[i]][, "RelativeTime.s"])[1] < 0 ) {
      stop("There are Feed Events that have a negative time stamp.")
      print(paste("Please check the format of the StartTime columns in", list.files(feedlog.path)[i] ,sep = " "))
    }
    
    feedlog.list[[i]][, "FeedStartTimeRelative"] <- as.numeric( as.character(feedlog.list[[i]][, "RelativeTime.s"]) )
    feedlog.list[[i]][, "RelativeTime.s"] <- NULL
    
    # `dplyr` cannot understand the POSIX objects. Re-define them as vectors.
    feedlog.list[[i]][, "StartTime"] <- as.character(feedlog.list[[i]][, "StartTime"])
  } else {
    feedlog.list[[i]][, "FeedStartTimeRelative"] <- as.numeric( as.character(feedlog.list[[i]][, "RelativeTime.s"]) )
    feedlog.list[[i]][, "RelativeTime.s"] <- NULL
  }
  
  # Add 1 to FeederIdx or ChoiceIdx, to match up with Food columns in metadata.  
  # Also, change both FeederIdx and ChoiceIdx to FoodIdx, so you can rbind later without problems.
  if ("FeederIdx" %in% colnames(feedlog.list[[i]])) {
    feedlog.list[[i]]$FeederIdx <- feedlog.list[[i]]$FeederIdx + 1
    feedlog.list[[i]]$FoodIdx <- feedlog.list[[i]]$FeederIdx
    feedlog.list[[i]]$FeederIdx <- NULL
  } else if ("ChoiceIdx" %in% colnames(feedlog.list[[i]])) {
    feedlog.list[[i]]$ChoiceIdx <- feedlog.list[[i]]$ChoiceIdx + 1
    feedlog.list[[i]]$FoodIdx <- feedlog.list[[i]]$ChoiceIdx
    feedlog.list[[i]]$ChoiceIdx <- NULL
  }  
  
  # Order the columns properly.
  feedlog.list[[i]] <- as.data.table( feedlog.list[[i]] )
  setcolorder(feedlog.list[[i]], colnames(feedlog.list[[1]]))
  feedlog.list[[i]] <- data.frame(feedlog.list[[i]])
  
  non.contrast.columns <- colnames(feedlog.list[[i]])
}

# Combine the feedlogs.
feedlog.all <- do.call('rbind', feedlog.list)
```

```{r ProcessAndCombineMetadata, message = FALSE, error = FALSE, echo = FALSE, eval = TRUE}
for (i in 1:length(metadata.list)) {
  
  # Rename Chamber.number column as ID.
  if ( "Chamber.number" %in% colnames(metadata.list[[i]]) ) {
    metadata.list[[i]][, "ID"] <- metadata.list[[i]][, "Chamber.number"]
    metadata.list[[i]][, "Chamber.number"] <- NULL
  }
  
  # Then rename ID as FlyID to be consistent with feedlog.all
  metadata.list[[i]][, "FlyID"] <- metadata.list[[i]][, "ID"]
  metadata.list[[i]][, "ID"] <- NULL
  
  # Then add previous number of flies from last metadata to avoid overlap of FlyIDs.
  if (i > 1) {
    metadata.list[[i]][, "FlyID"] <- 
      metadata.list[[i]][, "FlyID"] + 
      range(metadata.list[[i - 1]][, "FlyID"])[2]
  }
  
  #Order the columns properly.
  metadata.list[[i]] <- as.data.table( metadata.list[[i]] )
  setcolorder(metadata.list[[i]], colnames(metadata.list[[1]]))
  metadata.list[[i]] <- data.frame(metadata.list[[i]])
}

# Combine the metadata 
metadata.all <- do.call('rbind', metadata.list)
rownames(metadata.all) <- NULL

# Change all columns to uppercase, to mitigate capitilization errors.
for ( c in colnames(metadata.all) ) {
  metadata.all[, c] <- as.factor(toupper(metadata.all[, c]))
}

# Write to file.
write.csv(metadata.all, file = paste(output.path, "/metadata.all.csv", sep = ""), row.names = FALSE)
```

```{r ProcessFeedLog, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
feedlog.all[, "FoodIdx"] <- as.factor(feedlog.all[, "FoodIdx"])
no.feed.flies <- metadata.all[, "FlyID"][ !metadata.all[, "FlyID"] %in% feedlog.all[, "FlyID"] ]

# Add timebins to feedlog.all
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
feedlog.all[, n] <- seq(0, h * 3600, bw)[findInterval(feedlog.all$FeedStartTimeRelative, 
                                                      seq(0, h * 3600, bw))] + bw
feedlog.all[, n] <- factor(feedlog.all[, n], levels = seq(bw, h * 3600, bw)  )
all.time.bins <- seq(bw, h * 3600, bw)

if ( length(levels(feedlog.all[, "FoodIdx"])) > 1) {
  feedlog.food.choice.count <- 
    feedlog.all %>% 
    group_by(FlyID) %>%
    summarise(food.choices.taken = length(levels(droplevels(FoodIdx))),
              food.idx = paste(levels(droplevels(FoodIdx)), collapse = ", ") )
  
  feedlog.food.choice.count <- data.frame(feedlog.food.choice.count)
  
  t <- filter(feedlog.food.choice.count, food.choices.taken == 1)
  rownames(t) <- t[, "FlyID"]
  t[, "food.idx"] <- as.factor(t[, "food.idx"])
  
  # This adds in lines for flies that only fed on one food choice, to note that they did not feed on the other food choice.
  for (id in t[, "FlyID"]) {
    for (b in seq(bw, h * 3600, bw)) {
      temp.row <- c(rep(NA, 3),
                    id, NA, 0, 0,
                    rep(NA, 4), 
                    levels(t[, "food.idx"])[ !levels(t [, "food.idx"]) 
                                             %in% t[paste(id), "food.idx"] ], 
                    # Because id is numeric, you need to 'paste' it to refer to it as a rownumber.
                    b )
      feedlog.all <- rbind(feedlog.all, temp.row)
    }
  }
}

# This adds in lines for flies that did not feed into the feedlog, to note that they actually did not feed at all.
for (id in no.feed.flies) {
  for (i in 1 : length( levels(feedlog.all[, "FoodIdx"] ))) {
    for (b in seq(bw, h * 3600, bw)) {
      temp.row <-  c(rep(NA, 3),
                     id, NA, 0, 0,
                     rep(NA, 4), 
                     i, b )
      feedlog.all <- rbind(feedlog.all, temp.row)
    }
  }
}

# Now, check that each fly has a feedlog for each food choice, at each timebin. If not, create a line that notes a null feed event.

tt <- feedlog.all %>%
  group_by(FlyID, FoodIdx) %>%
  summarise_( number.of.time.bins = 
                interp( ~length( levels(droplevels(n)) ), n = as.symbol(n) ),
              missing.time.bins = interp( ~ paste(nn[ !nn %in%levels(droplevels(n))], collapse = ",") , 
                                          n = as.symbol(n),
                                          nn = as.name("all.time.bins") )
  )
tt <- data.frame(filter(tt, number.of.time.bins != length(all.time.bins)))

# This loop takes fairly long to run..... Why?
for ( rownum in 1:nrow(tt) ) {
  missing.time.bins <- unlist(base::strsplit(tt[ rownum, "missing.time.bins"], split = "\\,"))
  for (b in missing.time.bins) {
    temp.row <-  c(rep(NA, 3),
                   tt[rownum, "FlyID"], NA, 0, 0,
                   rep(NA, 4), 
                   tt[rownum, "FoodIdx"], b )
    feedlog.all <- rbind(feedlog.all, temp.row)
  }
}

# Convert Volume.mm3, Duration.ms, and FeedStartTimeRelative to numeric.
cc <- c("Volume.mm3", "Duration.ms", "FeedStartTimeRelative")
for (c in cc) {
  feedlog.all[, c] <- as.numeric( as.character(feedlog.all[, c]) )
}

# Convert Volume.mm3 to Volume.nanoliter
feedlog.all <- mutate(feedlog.all, Volume.nanoliter = Volume.mm3 * 1000)

# Convert Duration.ms to Duration.s
feedlog.all <- mutate(feedlog.all, Duration.s = Duration.ms / 1000)

# Calculate feeding speed
feedlog.all <- mutate(feedlog.all, feeding.speed.nl.per.s = Volume.nanoliter/ Duration.s )
```

```{r CombineFeedLogAndMetaData, message = FALSE, warning = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
# Prep before joining
metadata.all[, "FlyID"] <- as.factor(metadata.all[, "FlyID"])
feedlog.all[, "FlyID"] <- factor(feedlog.all[, "FlyID"], 
                                 levels = levels(metadata.all[, "FlyID"]) )

# Join (along columns) the feedlog and metadata by FlyID
rawdata.all <- full_join(feedlog.all, metadata.all, by = "FlyID")
```

```{r getAndSetContrasts, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
# Assign FoodType to the feed events
for (rownum in 1:nrow(rawdata.all)) {
  foodchoice.col <- paste("Food.", (rawdata.all[rownum, "FoodIdx"]), sep = "")
  rawdata.all[rownum, "FoodType"] <- as.character(rawdata.all[2, paste(foodchoice.col)])
}
rawdata.all[, "FoodType"] <- as.factor(rawdata.all[, "FoodType"])
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
food.columns <- paste("Food.", seq( 1:length(levels(rawdata.all$FoodIdx)) ), sep = "")

to.drop <- c("StartTime", "StartFrame", "FeedTubeIdx", "FlyID",                
             "AviFile", "Volume.mm3", "Duration.ms", "Duration.s", "Evap.mm3.s", "Evap.mm3.per.sec",        
             "Valid", "ExperimentState", "FeedStartTimeRelative", "FoodIdx",              
             "feeding.speed.nl.per.s", n, "Volume.nanoliter",  "Food.1", "Food.2")

to.check <- colnames(rawdata.all)[!colnames(rawdata.all) %in% to.drop]

# Check which columns have more than one level. 
for (c in to.check) {
  if ( length( levels( as.factor( rawdata.all[, c] ) ) ) == 1) {
    to.drop <- append(to.drop, c)
  }
}

# Then remove these columns from consideration, leaving us with the contrasts to crunch.
contrast.columns <- to.check[!to.check %in% to.drop]
contrast.columns.noFoodType <- contrast.columns[!contrast.columns %in% c("FoodType")]
```

```{r SetContrastReferenceLevels, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
# Code below to remove only columns that are entirely NA from
# http://stackoverflow.com/questions/15968494/how-to-delete-columns-with-na-in-r
rawdata.all <- rawdata.all[, !apply( rawdata.all, 2, function(x) all(is.na(x)))]

# Get rid of any feed events falling outside the experiment duration
rawdata.all[, "FeedStartTimeRelative"][is.na(rawdata.all[, "FeedStartTimeRelative"])] <- 0
rawdata.all[, "FeedStartTimeRelative"] <- as.numeric(as.character(rawdata.all[, "FeedStartTimeRelative"]))
rawdata.all <- filter(rawdata.all, FeedStartTimeRelative < h * 3600)
rawdata.all[, "FeedStartTimeRelative"][rawdata.all[, "FeedStartTimeRelative"] == 0] <- NA


# Read in reference levels.
ref.levels <- transpose(read.csv( file=paste(file.path,"/reference_levels.txt", sep = ""), header = TRUE))
colnames.ref.levels <- ref.levels[1,]
ref.levels <- data.frame(ref.levels[-c(1),])
colnames(ref.levels) <- colnames.ref.levels

# Loop below turns all reference levels to uppercase.
for ( c in colnames(ref.levels) ) {
  ref.levels[1, c] <- toupper(ref.levels[1, c])
}

# Order ref.levels according to contrast.columns
ref.levels <- as.data.table( ref.levels )
setcolorder(ref.levels, contrast.columns)
ref.levels <- data.frame(ref.levels)


# Set reference levels.
reflevels <- list()
for (i in contrast.columns) {
  rawdata.all[,i] <- as.factor( toupper(rawdata.all[,i]) ) # Makes sure contrast columns are factors, and to mitigate against capitalization errors.
  non.ref.levels <- levels(rawdata.all[,i])[!levels(rawdata.all[,i]) %in% ref.levels[,paste(i)]]
  set.ref.levels <- c(ref.levels[,paste(i)], non.ref.levels)
  reflevels[[paste(i)]] <- set.ref.levels
}

for (i in contrast.columns.noFoodType) {
  metadata.all[,i] <- as.factor( toupper(metadata.all[,i]) ) # Makes sure contrast columns are factors, and to mitigate against capitalization errors.
}

# Check that all contrast levels are captured correctly in `reference_levels.txt`.
if ( all.equal(names(reflevels), contrast.columns) == FALSE ) {
  stop("Contrast Levels in `reference_levels.txt` do not match the set of columns in the metadata with contrasts. Please check that all factors with contrasts (across all feedlogs) are indicated in  `reference_levels.txt`.")
}

## Why is this chunk of code here??
# levels.contrast.factors <- c()
# for ( i in 1:length(contrast.columns.noFoodType) ) {
#   for (d in contrast.columns.noFoodType[!contrast.columns.noFoodType %in% c(c)] )
#     levels.contrast.factors
# }

# Set order of levels for each experimental contrast, according to that dictated in `reference_levels.txt` and in `reflevels`.
for (c in contrast.columns) {
  rawdata.all[, c] <- factor(rawdata.all[, c], reflevels[[c]])
  rawdata.all <- arrange_(rawdata.all, c) # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
}

# Create new column in `rawdata.all` to combine all contrasts, without Food.
rawdata.all <- unite_(rawdata.all, "contrast.groups.noFoodType", contrast.columns.noFoodType, sep = "\n", remove = FALSE)

# Create new column in `rawdata.all` to combine all contrasts, with Food.
rawdata.all <- unite_(rawdata.all, "contrast.groups.withFoodType", contrast.columns, sep = "\n", remove = FALSE)

# Create new column in `rawdata.all` to combine contrasts with FlyID.
rawdata.all <- unite_(rawdata.all, "FlyID.contrast.groups.withFoodType", c("FlyID", contrast.columns), sep = "\n", remove = FALSE)

# Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
levels.contrast.groups.withFoodType <- unique(rawdata.all[, "contrast.groups.withFoodType"])
rawdata.all[, "contrast.groups.withFoodType"] <- factor(rawdata.all[, "contrast.groups.withFoodType"], 
                                                                levels.contrast.groups.withFoodType)

levels.contrast.groups.noFoodType <- unique(rawdata.all[, "contrast.groups.noFoodType"])
rawdata.all[, "contrast.groups.noFoodType"] <- factor(rawdata.all[, "contrast.groups.noFoodType"], 
                                                              levels.contrast.groups.noFoodType)
```

```{r IdentifyContrastNumbers, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
contrast.numbers <- list()
t <- dplyr::select( metadata.all, one_of(contrast.columns[!contrast.columns %in% c("FoodType")]) )

# Loop below turns all contrast groups (no Food Type) into uppercase, to match the contrast column factors.
for ( c in colnames(t) ) {
  t[, c] <- toupper(t[, c])
}
t <- dplyr::mutate(t, x = apply(t, 1, paste, collapse = "\n"))


contrast.numbers <- plyr::count(t, "x")
rownames(contrast.numbers) <- contrast.numbers[, "x"]
contrast.numbers[, "total.fly.count"] <- contrast.numbers[, "freq"]
contrast.numbers[, "freq"] <- NULL
contrast.numbers[, "x"] <- NULL
contrast.numbers[, "contrast.groups.noFoodType"] <- factor(rownames(contrast.numbers))
contrast.numbers[, "active.fly.count"] <- contrast.numbers[, "total.fly.count"]


# Find out which contrast group the non-feeding flies belong to.
no.feed.flies.metadata <- metadata.all[as.numeric(metadata.all[, "FlyID"][metadata.all[, "FlyID"] %in% no.feed.flies]), ]

t <- dplyr::select( no.feed.flies.metadata, one_of(contrast.columns[!contrast.columns %in% c("FoodType")]) )
t <- dplyr::mutate(t, x = apply(t, 1, paste, collapse = "\n"))
no.feed.flies.metadata[, "contrast.groups.noFoodType"] <- as.factor(t[, "x"])

nonactive.flies <- plyr::count(no.feed.flies.metadata, "contrast.groups.noFoodType")
rownames(nonactive.flies) <- nonactive.flies[, "contrast.groups.noFoodType"]

for (c in rownames(nonactive.flies)) {
  contrast.numbers[c, "active.fly.count"] <- contrast.numbers[c, "active.fly.count"] - nonactive.flies[c, "freq"]
}

```

```{r CumsumDataCrunch, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
rawdata.all <- arrange_(rawdata.all, "contrast.groups.withFoodType", "FlyID", n, "FeedStartTimeRelative")

cols <- c("contrast.groups.withFoodType", "FlyID")
dots <- lapply(cols, as.symbol)

rawdata.all <- 
  rawdata.all %>% 
  group_by_(.dots = dots) %>%
  mutate(cumulative.vol.nanoliter = cumsum(Volume.nanoliter) ) 
rawdata.all <- data.frame(rawdata.all)

rawdata.all[, "FlyID.contrast.groups.withFoodType"] <- factor(rawdata.all[, "FlyID.contrast.groups.withFoodType"])

# Make sure that binned column is numeric.
rawdata.all[, n] <- as.numeric ( as.character(rawdata.all[, n]) )

write.csv(rawdata.all, file = paste(output.path, "/rawdata.all.csv", sep = ""), row.names = FALSE)
```

```{r summaryPerFly, message = FALSE, error=FALSE, echo = FALSE , eval = TRUE}
# See http://stackoverflow.com/questions/21208801/group-by-multiple-columns-in-dplyr-using-string-vector-input
cols <- unique(c(contrast.columns, "FoodType", "FlyID")) # Need to group_by FoodType, regardless of whether it is a contrast factor or not.
dots <- lapply(cols, as.symbol)

summary.per.fly <- 
  rawdata.all %>% 
  group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
  summarise(total.feed.count = length( na.exclude(StartTime) ),
            time.to.first.feed.s = min( FeedStartTimeRelative, na.rm = TRUE ),
            total.vol.intake.nanoliter = sum(Volume.nanoliter))

# Create temp.rawdata, where all null feed events are marked with an NA.
temp.rawdata <- rawdata.all
temp.rawdata[, "Volume.mm3"][temp.rawdata[, "Volume.mm3"] == 0] <- NA
temp.rawdata[, "Duration.ms"][temp.rawdata[, "Duration.ms"] == 0] <- NA
temp.rawdata[, "Volume.nanoliter"][temp.rawdata[, "Volume.nanoliter"] == 0] <- NA
temp.rawdata[, "Duration.s"][temp.rawdata[, "Duration.s"] == 0] <- NA

extra.cols <- 
  temp.rawdata %>%
  group_by_(.dots = dots) %>%
  summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
            mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
            median.feed.duration.s = median(Duration.s, na.rm = TRUE),
            sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
            ci.lower.feed.duration.s = mean.feed.duration.s - 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
            ci.upper.feed.duration.s = mean.feed.duration.s + 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
            
            mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
            median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
            sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            
            mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
            median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
            sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
            ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
            ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ))

#  Remove the table.frame attributes so select_  and arrange_ works properly.
summary.per.fly <- as.data.frame(summary.per.fly) 
extra.cols <- data.frame(extra.cols)
summary.per.fly <- left_join(summary.per.fly, extra.cols, 
                             by = cols)

summary.per.fly <- data.frame(summary.per.fly)

for (c in contrast.columns) {
  summary.per.fly[, c] <- factor(summary.per.fly[, c], reflevels[[c]])
  summary.per.fly <- arrange_(summary.per.fly, c) # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
}

# Set CIs that drop below 0, to 0.
for (c in c("ci.lower.feed.duration.s",
            "ci.lower.feeding.speed.nl.per.s",
            "ci.lower.vol.per.feed.nanoliter") ) {
  summary.per.fly[, c][summary.per.fly[, c] < 0] <- 0
}

write.csv(summary.per.fly, file = paste(output.path, "/summary.per.fly.csv", sep = ""), row.names = FALSE)

# Create new column in `summary.per.fly` to combine all contrasts, without Food.
summary.per.fly <- unite_(summary.per.fly, "contrast.groups.noFoodType", contrast.columns.noFoodType, sep = "\n", remove = FALSE)

# Create new column in `summary.per.fly` to combine all contrasts, with Food.
summary.per.fly <- unite_(summary.per.fly, "contrast.groups.withFoodType", contrast.columns, sep = "\n", remove = FALSE)

# Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
summary.per.fly[, "contrast.groups.withFoodType"] <- factor(summary.per.fly[, "contrast.groups.withFoodType"], 
                                                        levels.contrast.groups.withFoodType)

summary.per.fly[, "contrast.groups.noFoodType"] <- factor(summary.per.fly[, "contrast.groups.noFoodType"], 
                                                      levels.contrast.groups.noFoodType)
```

```{r summaryPerContrastGroupWithFood, message = FALSE, error = TRUE, echo = FALSE, eval = TRUE}
temp.perFly <- summary.per.fly
temp.perFly[, "total.feed.count"][temp.perFly[, "total.feed.count"] == 0] <- NA

if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  cols <- unique(c(contrast.columns, "FoodType"))
  # Need to group_by FoodType, regardless of whether it is a contrast factor or not.
  dots <- lapply(cols, as.symbol)
  
  summary.per.contrastGroup.withFood <- 
    temp.rawdata %>% 
    group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
    summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
              mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
              median.feed.duration.s = median(Duration.s, na.rm = TRUE),
              sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
              ci.lower.feed.duration.s = mean.feed.duration.s - 
                1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
              ci.upper.feed.duration.s = mean.feed.duration.s + 
                1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
              
              mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
              median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
              sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
              ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
                1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
              ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
                1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ),
              
              mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
              median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
              sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
              ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
                1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
              ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
                1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ))
  
  extra <- 
    summary.per.fly %>%
    group_by_(.dots = dots) %>%
    summarise(sum.feed.count = sum(total.feed.count),
              mean.total.feed.count.per.fly = mean(total.feed.count),
              median.total.feed.count.per.fly = median(total.feed.count),
              sd.total.feed.count.per.fly = sd(total.feed.count),
              ci.lower.mean.total.feed.count.per.fly = mean(total.feed.count) - 
                1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ), 
              ci.upper.mean.total.feed.count.per.fly = mean(total.feed.count) + 
                1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ),
              
              mean.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)),
              median.vol.per.feed.per.fly.nanoliter = median(na.exclude(mean.vol.per.feed.nanoliter)),
              sd.vol.per.feed.per.fly.nanoliter = sd(na.exclude(mean.vol.per.feed.nanoliter)),
              ci.lower.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) - 
                1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ), 
              ci.upper.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) + 
                1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ),
              
              mean.feeding.speed.per.fly.nl.per.s = mean(na.exclude(mean.feeding.speed.nl.per.s)),
              median.feeding.speed.per.fly.nl.per.s = median(na.exclude(mean.feeding.speed.nl.per.s)),
              sd.feeding.speed.per.fly.nl.per.s = sd(na.exclude(mean.feeding.speed.nl.per.s)),
              ci.lower.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s -
                1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
              ci.upper.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s +
                1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
              
              grand.total.vol.intake.nanoliter = sum(total.vol.intake.nanoliter),
              mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter),
              median.total.vol.intake.nanoliter = median(total.vol.intake.nanoliter),
              sd.mean.total.vol.intake.nanoliter = sd(total.vol.intake.nanoliter),
              ci.lower.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) - 
                1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ), 
              ci.upper.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) + 
                1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ),
              
              mean.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)),
              median.time.to.first.feed.s = median(na.exclude(time.to.first.feed.s)),
              sd.time.to.first.feed.s = sd(na.exclude(time.to.first.feed.s)),
              ci.lower.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) - 
                1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ), 
              ci.upper.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) + 
                1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ) )
  
  extra.cols <- temp.perFly %>%
    group_by_(.dots = dots) %>%
    summarise(total.fly.count = length(total.feed.count),
              feeding.fly.count = length(na.exclude(total.feed.count)))
  
  # Obtain friendly dataframes.
  summary.per.contrastGroup.withFood <- data.frame(summary.per.contrastGroup.withFood)
  extra <- data.frame(extra)
  extra.cols <- data.frame(extra.cols)
  
  # Then join them.
  summary.per.contrastGroup.withFood <- left_join(extra.cols, 
                                                  left_join(extra,
                                                            summary.per.contrastGroup.withFood,
                                                            by = cols),   
                                                  by = cols)
  
  # Joining the dataframes might coerce the contrast columns into characters. This fixes that.
  for (c in contrast.columns) {
    summary.per.contrastGroup.withFood[, c]<- factor(summary.per.contrastGroup.withFood[, c], levels = reflevels[[c]])
  }

  # Then round to nice significant digits.
  for (c in colnames(summary.per.contrastGroup.withFood) ) {
    if ( is.numeric(summary.per.contrastGroup.withFood[, c]) &&
         abs(range(summary.per.contrastGroup.withFood[, c], na.rm = TRUE)[2]) < 1) {
      summary.per.contrastGroup.withFood[, c] <- signif(summary.per.contrastGroup.withFood[, c], digits = 3)
    } else if (is.numeric(summary.per.contrastGroup.withFood[, c]) &&
               abs(range(summary.per.contrastGroup.withFood[, c], na.rm = TRUE)[2]) > 1) {
      summary.per.contrastGroup.withFood[, c] <- round(summary.per.contrastGroup.withFood[, c], digits = 2)
    }
  }

  
  # Set CIs that drop below 0, to 0.
  for (c in c("ci.lower.vol.per.feed.nanoliter",
              "ci.lower.feeding.speed.nl.per.s",
              "ci.lower.vol.per.feed.per.fly.nanoliter",
              "ci.lower.feeding.speed.per.fly.nl.per.s",
              "ci.lower.feed.duration.s",
              "ci.lower.mean.total.feed.count.per.fly",
              "ci.lower.mean.total.vol.intake.nanoliter",
              "ci.lower.time.to.first.feed.s") ) {
    summary.per.contrastGroup.withFood[, c][summary.per.contrastGroup.withFood[, c] < 0] <- 0
  }
  
  summary.per.contrastGroup.withFood <- data.frame(summary.per.contrastGroup.withFood)

  # Ensures that the dataframe is sorted according to the factor level order we want.
  for (c in contrast.columns) {
    summary.per.contrastGroup.withFood[, c] <- factor(summary.per.contrastGroup.withFood[, c], reflevels[[c]])
    summary.per.contrastGroup.withFood <- arrange_(summary.per.contrastGroup.withFood, c) # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
  }  
  # Write to file.
  write.csv(summary.per.contrastGroup.withFood, 
            file = paste(output.path, "/summary.per.contrastGroup.withFood.csv", sep = ""), 
            row.names = FALSE)
  
  # Create new column in `summary.per.contrastGroup.withFood` to combine all contrasts, with Food.
  summary.per.contrastGroup.withFood <- unite_(summary.per.contrastGroup.withFood, 
                                               "contrast.groups.withFoodType", 
                                               contrast.columns, sep = "\n", remove = FALSE)
  
  
  # Create new column in `summary.per.contrastGroup.withFood` to combine all contrasts, without Food.
  summary.per.contrastGroup.withFood <- unite_(summary.per.contrastGroup.withFood, 
                                             "contrast.groups.noFoodType", 
                                             contrast.columns.noFoodType, sep = "\n", remove = FALSE)
  
  # Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
  summary.per.contrastGroup.withFood[, "contrast.groups.withFoodType"] <- factor(summary.per.contrastGroup.withFood[, "contrast.groups.withFoodType"], 
                                                                                 levels.contrast.groups.withFoodType)
  
  summary.per.contrastGroup.withFood[, "contrast.groups.noFoodType"] <- factor(summary.per.contrastGroup.withFood[, "contrast.groups.noFoodType"], 
                                                                             levels.contrast.groups.noFoodType)
}
```

```{r summaryPerContrastGroupNoFood, message = FALSE, error = TRUE, echo = FALSE, eval = TRUE}
cols <- contrast.columns.noFoodType
dots <- lapply(cols, as.symbol)

summary.per.contrastGroup.noFood <- 
  temp.rawdata %>% 
  group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
  summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
            mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
            median.feed.duration.s = median(Duration.s, na.rm = TRUE),
            sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
            ci.lower.feed.duration.s = mean.feed.duration.s - 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
            ci.upper.feed.duration.s = mean.feed.duration.s + 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
            
            mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
            median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
            sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
            ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
            ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ),
            
            mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
            median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
            sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ))

extra <- 
  summary.per.fly %>%
  group_by_(.dots = dots) %>%
  summarise(sum.feed.count = sum(total.feed.count),
            mean.total.feed.count.per.fly = mean(total.feed.count),
            median.total.feed.count.per.fly = median(total.feed.count),
            sd.total.feed.count.per.fly = sd(total.feed.count),
            ci.lower.mean.total.feed.count.per.fly = mean(total.feed.count) - 
              1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ), 
            ci.upper.mean.total.feed.count.per.fly = mean(total.feed.count) + 
              1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ),
            
            mean.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)),
            median.vol.per.feed.per.fly.nanoliter = median(na.exclude(mean.vol.per.feed.nanoliter)),
            sd.vol.per.feed.per.fly.nanoliter = sd(na.exclude(mean.vol.per.feed.nanoliter)),
            ci.lower.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) - 
              1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ), 
            ci.upper.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) + 
              1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ),
            
            mean.feeding.speed.per.fly.nl.per.s = mean(na.exclude(mean.feeding.speed.nl.per.s)),
            median.feeding.speed.per.fly.nl.per.s = median(na.exclude(mean.feeding.speed.nl.per.s)),
            sd.feeding.speed.per.fly.nl.per.s = sd(na.exclude(mean.feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s -
              1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s +
              1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
            
            grand.total.vol.intake.nanoliter = sum(total.vol.intake.nanoliter),
            mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter),
            median.total.vol.intake.nanoliter = median(total.vol.intake.nanoliter),
            sd.mean.total.vol.intake.nanoliter = sd(total.vol.intake.nanoliter),
            ci.lower.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) - 
              1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ), 
            ci.upper.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) + 
              1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ),
            
            mean.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)),
            median.time.to.first.feed.s = median(na.exclude(time.to.first.feed.s)),
            sd.time.to.first.feed.s = sd(na.exclude(time.to.first.feed.s)),
            ci.lower.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) - 
              1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ), 
            ci.upper.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) + 
              1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ) )

extra.cols <- temp.perFly %>%
  group_by_(.dots = dots) %>%
  summarise(total.fly.count = length(total.feed.count),
            feeding.fly.count = length(na.exclude(total.feed.count)))

# Obtain friendly dataframes.
summary.per.contrastGroup.noFood <- data.frame(summary.per.contrastGroup.noFood)
extra <- data.frame(extra)
extra.cols <- data.frame(extra.cols)

# Then join them.
summary.per.contrastGroup.noFood <- left_join(extra.cols, 
                                                left_join(extra,
                                                          summary.per.contrastGroup.noFood,
                                                          by = cols),   
                                                by = cols)

# Joining the dataframes might coerce the contrast columns into characters. This fixes that.
for (c in contrast.columns.noFoodType) {
  summary.per.contrastGroup.noFood[, c]<- factor(summary.per.contrastGroup.noFood[, c], levels = reflevels[[c]])
}

# Then round to nice significant digits.
for (c in colnames(summary.per.contrastGroup.noFood) ) {
  if ( is.numeric(summary.per.contrastGroup.noFood[, c]) && 
       abs(range(summary.per.contrastGroup.noFood[, c], na.rm = TRUE)[2]) < 1) {
    summary.per.contrastGroup.noFood[, c] <- signif(summary.per.contrastGroup.noFood[, c], digits = 3)
  } else if (is.numeric(summary.per.contrastGroup.noFood[, c]) && 
             abs(range(summary.per.contrastGroup.noFood[, c], na.rm = TRUE)[2]) > 1) {
    summary.per.contrastGroup.noFood[, c] <- round(summary.per.contrastGroup.noFood[, c], digits = 2)
  }
}

# Set CIs that drop below 0, to 0.
  for (c in c("ci.lower.feed.duration.s",
              "ci.lower.vol.per.feed.nanoliter",
              "ci.lower.feeding.speed.nl.per.s",
              "ci.lower.mean.total.feed.count.per.fly",
              "ci.lower.vol.per.feed.per.fly.nanoliter",
              "ci.lower.feeding.speed.per.fly.nl.per.s",
              "ci.lower.mean.total.vol.intake.nanoliter",
              "ci.lower.time.to.first.feed.s") ) {
  summary.per.contrastGroup.noFood[, c][summary.per.contrastGroup.noFood[, c] < 0] <- 0
}

summary.per.contrastGroup.noFood <- data.frame(summary.per.contrastGroup.noFood)

# Ensures that the dataframe is sorted according to the factor level order we want.
for (c in contrast.columns.noFoodType) {
  summary.per.contrastGroup.noFood[, c] <- factor(summary.per.contrastGroup.noFood[, c], 
                                                  reflevels[[c]])
  summary.per.contrastGroup.noFood <- arrange_(summary.per.contrastGroup.noFood, c) 
  # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
}


# Create new column in `summary.per.contrastGroup.noFood` to combine all contrasts, with Food.
summary.per.contrastGroup.noFood <- unite_(summary.per.contrastGroup.noFood, 
                                           "contrast.groups.noFoodType", 
                                           contrast.columns.noFoodType, 
                                           sep = "\n", remove = FALSE)

# Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
summary.per.contrastGroup.noFood[, "contrast.groups.noFoodType"] <-  factor(summary.per.contrastGroup.noFood[, "contrast.groups.noFoodType"], 
                                                      levels.contrast.groups.noFoodType)

summary.per.contrastGroup.noFood <- 
  mutate(summary.per.contrastGroup.noFood,
         proportion.feeding = signif(feeding.fly.count/total.fly.count, digits = 3),
         ci.lower.proportion.feeding = signif(proportion.feeding -
                                                1.96 * sqrt( proportion.feeding * (1 - proportion.feeding) / total.fly.count ), digits = 3),
         ci.upper.proportion.feeding = signif(proportion.feeding +
                                                1.96 * sqrt( proportion.feeding * (1 - proportion.feeding) / total.fly.count ), digits = 3) )

# Set CIs that drop below 0, to 0, and CIs that go above 1, to 1.
for (c in c("ci.lower.proportion.feeding")) {
  summary.per.contrastGroup.noFood[, c][summary.per.contrastGroup.noFood[, c] < 0] <- 0
}
for (c in c("ci.upper.proportion.feeding")) {
  summary.per.contrastGroup.noFood[, c][summary.per.contrastGroup.noFood[, c] > 1] <- 1
}

write.csv(summary.per.contrastGroup.noFood, 
          file = paste(output.path, "/summary.per.contrastGroup.noFood.csv", sep = ""), 
          row.names = FALSE)

```

```{r TimeCoursePerFly, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
cols <- unique(c(n, contrast.columns, "FoodType", "FlyID")) 
dots <- lapply(cols, as.symbol)

bin.per.fly <- 
  rawdata.all %>% 
  group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
  summarise(total.feed.count = length( na.exclude(StartTime) ),
            time.to.first.feed.s = min( FeedStartTimeRelative, na.rm = TRUE ),
            total.vol.intake.nanoliter = sum(Volume.nanoliter),
            cumulative.vol.intake.nanoliter = range(cumulative.vol.nanoliter)[2] )

extra.cols <- 
  temp.rawdata %>%
  group_by_(.dots = dots) %>%
  summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
            mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
            median.feed.duration.s = median(Duration.s, na.rm = TRUE),
            sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
            ci.lower.feed.duration.s = mean.feed.duration.s - 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
            ci.upper.feed.duration.s = mean.feed.duration.s + 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
            
            mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
            median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
            sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            
            mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
            median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
            sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
            ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
            ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ))

#  Remove the table.frame attributes so select_  and arrange_ works properly.
bin.per.fly <- as.data.frame(bin.per.fly) 
extra.cols <- data.frame(extra.cols)
bin.per.fly <- left_join(bin.per.fly, extra.cols, 
                         by = cols)

# Set CIs that drop below 0, to 0.
for (c in c("ci.lower.feed.duration.s",
            "ci.lower.feeding.speed.nl.per.s",
            "ci.lower.vol.per.feed.nanoliter") ) {
  summary.per.fly[, c][summary.per.fly[, c] < 0] <- 0
}

write.csv(bin.per.fly, 
          file = paste(output.path, "/bin.per.fly.", n, ".csv", sep = ""), 
          row.names = FALSE)

bin.per.fly <- data.frame(bin.per.fly)

for (c in contrast.columns) {
  bin.per.fly[, c] <- factor(bin.per.fly[, c], reflevels[[c]])
  bin.per.fly <- arrange_(bin.per.fly, c) 
  # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
}

# Create new column in `bin.per.fly` to combine all contrasts, with Food.
bin.per.fly <- unite_(bin.per.fly, "contrast.groups.withFoodType", 
                      contrast.columns, 
                      sep = "\n", 
                      remove = FALSE)

# Create new column in `bin.per.fly` to combine all contrasts, without Food.
bin.per.fly <- unite_(bin.per.fly, "contrast.groups.noFoodType", 
                      contrast.columns.noFoodType, 
                      sep = "\n", 
                      remove = FALSE)

# Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
bin.per.fly[, "contrast.groups.withFoodType"] <- factor(bin.per.fly[, "contrast.groups.withFoodType"], 
                                                        levels.contrast.groups.withFoodType)

bin.per.fly[, "contrast.groups.noFoodType"] <-  factor(bin.per.fly[, "contrast.groups.noFoodType"], 
                                                      levels.contrast.groups.noFoodType)

# Make sure binned time column is a numeric column.
bin.per.fly[, n] <- as.numeric( as.character(bin.per.fly[, n]) )

```

```{r TimeCoursePerContrastGroupWithFood, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
temp.bin.perFly <- bin.per.fly
temp.bin.perFly[, "total.feed.count"][temp.bin.perFly[, "total.feed.count"] == 0] <- NA

if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  n <- paste("bin.", as.character(bw/60), ".min", sep = "")
  cols <- unique(c(n, contrast.columns, "FoodType")) 
  dots <- lapply(cols, as.symbol)
  
  bin.per.contrastGroup.withFood <- 
    temp.rawdata %>% 
    group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
    summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
              mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
              median.feed.duration.s = median(Duration.s, na.rm = TRUE),
              sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
              ci.lower.feed.duration.s = mean.feed.duration.s - 
                1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
              ci.upper.feed.duration.s = mean.feed.duration.s + 
                1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
              
              mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
              median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
              sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
              ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
                1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
              ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
                1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ),
              
              mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
              median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
              sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
              ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
                1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
              ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
                1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ))
  
  extra <-
    bin.per.fly %>%
    group_by_(.dots = dots) %>%
    summarise(sum.feed.count = sum(total.feed.count),
              mean.total.feed.count.per.fly = mean(total.feed.count),
              median.total.feed.count.per.fly = median(total.feed.count),
              sd.total.feed.count.per.fly = sd(total.feed.count),
              ci.lower.mean.total.feed.count.per.fly = mean(total.feed.count) - 
                1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ), 
              ci.upper.mean.total.feed.count.per.fly = mean(total.feed.count) + 
                1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ),
              
              mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter),
              sd.mean.cumulative.vol.intake.nanoliter = sd(cumulative.vol.intake.nanoliter),
              ci.lower.mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter) - 
                1.96 * ( sd(cumulative.vol.intake.nanoliter) / sqrt(length(cumulative.vol.intake.nanoliter)) ), 
              ci.upper.mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter) + 
                1.96 * ( sd(cumulative.vol.intake.nanoliter) / sqrt(length(cumulative.vol.intake.nanoliter)) ) )
  
  extra.cols <- 
    temp.bin.perFly %>%
    group_by_(.dots = dots) %>%
    summarise(mean.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)),
              median.vol.per.feed.per.fly.nanoliter = median(na.exclude(mean.vol.per.feed.nanoliter)),
              sd.vol.per.feed.per.fly.nanoliter = sd(na.exclude(mean.vol.per.feed.nanoliter)),
              ci.lower.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) - 
                1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ), 
              ci.upper.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) + 
                1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ),
              
              mean.feeding.speed.per.fly.nl.per.s = mean(na.exclude(mean.feeding.speed.nl.per.s)),
              median.feeding.speed.per.fly.nl.per.s = median(na.exclude(mean.feeding.speed.nl.per.s)),
              sd.feeding.speed.per.fly.nl.per.s = sd(na.exclude(mean.feeding.speed.nl.per.s)),
              ci.lower.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s -
                1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
              ci.upper.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s +
                1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
              
              grand.total.vol.intake.nanoliter = sum(total.vol.intake.nanoliter),
              mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter),
              median.total.vol.intake.nanoliter = median(total.vol.intake.nanoliter),
              sd.mean.total.vol.intake.nanoliter = sd(total.vol.intake.nanoliter),
              ci.lower.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) - 
                1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ), 
              ci.upper.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) + 
                1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ),
              
              mean.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)),
              median.time.to.first.feed.s = median(na.exclude(time.to.first.feed.s)),
              sd.time.to.first.feed.s = sd(na.exclude(time.to.first.feed.s)),
              ci.lower.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) - 
                1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ), 
              ci.upper.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) + 
                1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ) )
  
  extra.cols2 <- 
    temp.bin.perFly %>%
    group_by_(.dots = dots) %>%
    summarise(total.fly.count = length(total.feed.count),
              feeding.fly.count = length(na.exclude(total.feed.count)))
  
  # Obtain friendly dataframes.
  bin.per.contrastGroup.withFood <- data.frame(bin.per.contrastGroup.withFood)
  extra <- data.frame(extra)
  extra.cols <- data.frame(extra.cols)
  
  # Then join them.
  bin.per.contrastGroup.withFood <- left_join(extra.cols2, 
                                              left_join(extra,
                                                        left_join(extra.cols,
                                                                  bin.per.contrastGroup.withFood,
                                                                  by = cols),   
                                                        by = cols),
                                              by = cols)

  
  # Then round to nice significant digits.
  for (c in colnames(bin.per.contrastGroup.withFood) ) {
    if ( is.numeric(bin.per.contrastGroup.withFood[, c]) && 
         abs( range(bin.per.contrastGroup.withFood[, c], na.rm = TRUE)[2]) < 1 ) {
      bin.per.contrastGroup.withFood[, c] <- signif(bin.per.contrastGroup.withFood[, c], digits = 3)
    } else if ( is.numeric(bin.per.contrastGroup.withFood[, c]) && 
                abs(range(bin.per.contrastGroup.withFood[, c], na.rm = TRUE)[2]) > 1 ) {
      bin.per.contrastGroup.withFood[, c] <- round(bin.per.contrastGroup.withFood[, c], digits = 2)
    }
  }
  
  # Set CIs for bins with single feed counts to mean. 
  for (r in 1:nrow(bin.per.contrastGroup.withFood)) {
    if (bin.per.contrastGroup.withFood[r, "sum.feed.count"] == 1 || bin.per.contrastGroup.withFood[r, "feeding.fly.count"] == 1) {
        bin.per.contrastGroup.withFood[r, "ci.lower.vol.per.feed.nanoliter"] <- bin.per.contrastGroup.withFood[r, "mean.vol.per.feed.nanoliter"]
        bin.per.contrastGroup.withFood[r, "ci.upper.vol.per.feed.nanoliter"] <- bin.per.contrastGroup.withFood[r, "mean.vol.per.feed.nanoliter"]
        
        bin.per.contrastGroup.withFood[r, "ci.lower.vol.per.feed.per.fly.nanoliter"] <- bin.per.contrastGroup.withFood[r, "mean.vol.per.feed.per.fly.nanoliter"]
        bin.per.contrastGroup.withFood[r, "ci.upper.vol.per.feed.per.fly.nanoliter"] <- bin.per.contrastGroup.withFood[r, "mean.vol.per.feed.per.fly.nanoliter"]
        
        bin.per.contrastGroup.withFood[r, "ci.lower.feed.duration.s"] <- bin.per.contrastGroup.withFood[r, "mean.feed.duration.s"]
        bin.per.contrastGroup.withFood[r, "ci.upper.feed.duration.s"] <- bin.per.contrastGroup.withFood[r, "mean.feed.duration.s"]
        
        bin.per.contrastGroup.withFood[r, "ci.lower.mean.total.feed.count.per.fly"] <- bin.per.contrastGroup.withFood[r, "mean.total.feed.count.per.fly"]
        bin.per.contrastGroup.withFood[r, "ci.upper.mean.total.feed.count.per.fly"] <- bin.per.contrastGroup.withFood[r, "mean.total.feed.count.per.fly"]
        
        bin.per.contrastGroup.withFood[r, "ci.lower.feeding.speed.per.fly.nl.per.s"] <- bin.per.contrastGroup.withFood[r, "mean.feeding.speed.per.fly.nl.per.s"]
        bin.per.contrastGroup.withFood[r, "ci.upper.feeding.speed.per.fly.nl.per.s"] <- bin.per.contrastGroup.withFood[r, "mean.feeding.speed.per.fly.nl.per.s"]
    }
  }
  
 
  # Set CIs that drop below 0, to 0.
  for (c in c("ci.lower.vol.per.feed.nanoliter",
              "ci.lower.feeding.speed.nl.per.s",
              "ci.lower.vol.per.feed.per.fly.nanoliter",
              "ci.lower.feeding.speed.per.fly.nl.per.s",
              "ci.lower.feed.duration.s",
              "ci.lower.mean.total.feed.count.per.fly",
              "ci.lower.mean.cumulative.vol.intake.nanoliter",
              "ci.lower.mean.total.vol.intake.nanoliter",
              "ci.lower.time.to.first.feed.s") ) {
    bin.per.contrastGroup.withFood[, c][bin.per.contrastGroup.withFood[, c] < 0] <- 0
  }
  
  
  # Turn NAs to '0' for proper plotting.
  for ( c in (length(contrast.columns) + 2):ncol(bin.per.contrastGroup.withFood) ) {
    bin.per.contrastGroup.withFood[, c][ is.na(bin.per.contrastGroup.withFood[, c])] <- 0
  }
  
  bin.per.contrastGroup.withFood <- data.frame(bin.per.contrastGroup.withFood)
  
  write.csv(bin.per.contrastGroup.withFood, 
            file = paste(output.path, "/bin.per.contrastGroup.withFood.csv", sep = ""), 
            row.names = FALSE)
  
  for (c in contrast.columns) {
    bin.per.contrastGroup.withFood[, c] <- factor(bin.per.contrastGroup.withFood[, c], 
                                                  levels = reflevels[[c]])
    bin.per.contrastGroup.withFood <- arrange_(bin.per.contrastGroup.withFood, c) 
    # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
  }

  # Create new column in `bin.per.contrastGroup.withFood` to combine all contrasts, with Food.
  bin.per.contrastGroup.withFood <- unite_(bin.per.contrastGroup.withFood, "contrast.groups.withFoodType", 
                                           contrast.columns, 
                                           sep = "\n", 
                                           remove = FALSE)
  
  # Create new column in `bin.per.contrastGroup.withFood` to combine all contrasts, without Food.
  bin.per.contrastGroup.withFood <- unite_(bin.per.contrastGroup.withFood, "contrast.groups.noFoodType", 
                                           contrast.columns.noFoodType, 
                                           sep = "\n", 
                                           remove = FALSE)
  
  # Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
  bin.per.contrastGroup.withFood[, "contrast.groups.withFoodType"] <- factor(bin.per.contrastGroup.withFood[, "contrast.groups.withFoodType"], levels = levels.contrast.groups.withFoodType)
  
  bin.per.contrastGroup.withFood[, "contrast.groups.noFoodType"] <-  factor(bin.per.contrastGroup.withFood[, "contrast.groups.noFoodType"], levels = levels.contrast.groups.noFoodType)
  
  # Make sure binned time column is a numeric column.
  bin.per.contrastGroup.withFood[, n] <- as.numeric( as.character(bin.per.contrastGroup.withFood[, n]) )
}
```

```{r TimeCoursePerContrastGroupNoFood, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
cols <- unique(c(n, contrast.columns.noFoodType)) 
dots <- lapply(cols, as.symbol)

bin.per.contrastGroup.noFood <- 
  temp.rawdata %>% 
  group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
  summarise(total.feed.duration.s = sum(Duration.s, na.rm = TRUE), 
            mean.feed.duration.s = mean(Duration.s, na.rm = TRUE), 
            median.feed.duration.s = median(Duration.s, na.rm = TRUE),
            sd.feed.duration.s = sd(Duration.s, na.rm = TRUE), 
            ci.lower.feed.duration.s = mean.feed.duration.s - 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ), 
            ci.upper.feed.duration.s = mean.feed.duration.s + 
              1.96 * ( sd.feed.duration.s / sqrt( length(na.exclude(Duration.s))) ),
            
            mean.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)),
            median.vol.per.feed.nanoliter = median(na.exclude(Volume.nanoliter)),
            sd.vol.per.feed.nanoliter = sd(na.exclude(Volume.nanoliter)),
            ci.lower.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) - 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ), 
            ci.upper.vol.per.feed.nanoliter = mean(na.exclude(Volume.nanoliter)) + 
              1.96 * ( sd(na.exclude(Volume.nanoliter)) / sqrt(length(na.exclude(Volume.nanoliter))) ),
            
            mean.feeding.speed.nl.per.s = mean(na.exclude(feeding.speed.nl.per.s)),
            median.feeding.speed.nl.per.s = median(na.exclude(feeding.speed.nl.per.s)),
            sd.feeding.speed.nl.per.s = sd(na.exclude(feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s -
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.nl.per.s = mean.feeding.speed.nl.per.s +
              1.96 * (sd.feeding.speed.nl.per.s / sqrt(length(na.exclude(feeding.speed.nl.per.s))) ))


extra <-
  bin.per.fly %>%
  group_by_(.dots = dots) %>%
  summarise(sum.feed.count = sum(total.feed.count),
            mean.total.feed.count.per.fly = mean(total.feed.count),
            median.total.feed.count.per.fly = median(total.feed.count),
            sd.total.feed.count.per.fly = sd(total.feed.count),
            ci.lower.mean.total.feed.count.per.fly = mean(total.feed.count) - 
              1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ), 
            ci.upper.mean.total.feed.count.per.fly = mean(total.feed.count) + 
              1.96 * ( sd(total.feed.count) / sqrt(length(total.feed.count)) ),
            
             mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter),
              sd.mean.cumulative.vol.intake.nanoliter = sd(cumulative.vol.intake.nanoliter),
              ci.lower.mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter) - 
                1.96 * ( sd(cumulative.vol.intake.nanoliter) / sqrt(length(cumulative.vol.intake.nanoliter)) ), 
              ci.upper.mean.cumulative.vol.intake.nanoliter = mean(cumulative.vol.intake.nanoliter) + 
                1.96 * ( sd(cumulative.vol.intake.nanoliter) / sqrt(length(cumulative.vol.intake.nanoliter)) ) )

extra.cols <- 
  temp.bin.perFly %>%
  group_by_(.dots = dots) %>%
  summarise(mean.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)),
            median.vol.per.feed.per.fly.nanoliter = median(na.exclude(mean.vol.per.feed.nanoliter)),
            sd.vol.per.feed.per.fly.nanoliter = sd(na.exclude(mean.vol.per.feed.nanoliter)),
            ci.lower.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) - 
              1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ), 
            ci.upper.vol.per.feed.per.fly.nanoliter = mean(na.exclude(mean.vol.per.feed.nanoliter)) + 
              1.96 * ( sd(na.exclude(mean.vol.per.feed.nanoliter)) / sqrt(length(na.exclude(mean.vol.per.feed.nanoliter))) ),
            
            mean.feeding.speed.per.fly.nl.per.s = mean(na.exclude(mean.feeding.speed.nl.per.s)),
            median.feeding.speed.per.fly.nl.per.s = median(na.exclude(mean.feeding.speed.nl.per.s)),
            sd.feeding.speed.per.fly.nl.per.s = sd(na.exclude(mean.feeding.speed.nl.per.s)),
            ci.lower.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s -
              1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
            ci.upper.feeding.speed.per.fly.nl.per.s = mean.feeding.speed.per.fly.nl.per.s +
              1.96 * (sd.feeding.speed.per.fly.nl.per.s / sqrt(length(na.exclude(mean.feeding.speed.nl.per.s))) ),
            
            grand.total.vol.intake.nanoliter = sum(total.vol.intake.nanoliter),
            mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter),
            median.total.vol.intake.nanoliter = median(total.vol.intake.nanoliter),
            sd.mean.total.vol.intake.nanoliter = sd(total.vol.intake.nanoliter),
            ci.lower.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) - 
              1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ), 
            ci.upper.mean.total.vol.intake.nanoliter = mean(total.vol.intake.nanoliter) + 
              1.96 * ( sd(total.vol.intake.nanoliter) / sqrt(length(total.vol.intake.nanoliter)) ),
            
            mean.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)),
            median.time.to.first.feed.s = median(na.exclude(time.to.first.feed.s)),
            sd.time.to.first.feed.s = sd(na.exclude(time.to.first.feed.s)),
            ci.lower.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) - 
              1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ), 
            ci.upper.time.to.first.feed.s = mean(na.exclude(time.to.first.feed.s)) + 
              1.96 * ( sd(na.exclude(time.to.first.feed.s)) / sqrt(length(na.exclude(time.to.first.feed.s))) ) )

extra.cols2 <- 
  temp.bin.perFly %>%
  group_by_(.dots = dots) %>%
  summarise(total.fly.count = length(total.feed.count),
            feeding.fly.count = length(na.exclude(total.feed.count)),
            
            feeding.fly.count = length(na.exclude(total.feed.count)),
            feeding.fly.proportion = feeding.fly.count / total.fly.count,
            sem.feeding.fly.proportion = sqrt( feeding.fly.proportion * (1 - feeding.fly.proportion) / feeding.fly.count ),
            ci.lower.feeding.fly.proportion = feeding.fly.proportion - 1.96 * sem.feeding.fly.proportion,
            ci.upper.feeding.fly.proportion = feeding.fly.proportion + 1.96 * sem.feeding.fly.proportion)

# Obtain friendly dataframes.
bin.per.contrastGroup.noFood <- data.frame(bin.per.contrastGroup.noFood)
extra <- data.frame(extra)
extra.cols <- data.frame(extra.cols)
extra.cols2 <- data.frame(extra.cols2)

# Then join them.
bin.per.contrastGroup.noFood <- left_join(extra.cols2, 
                                          left_join(bin.per.contrastGroup.noFood,
                                                    left_join(extra, 
                                                              extra.cols,
                                                              by = cols), 
                                                    by = cols), 
                                          by = cols)

# Joining the dataframes might coerce the contrast columns into characters. This fixes that.
for (c in contrast.columns.noFoodType) {
  bin.per.contrastGroup.noFood[, c]<- factor(bin.per.contrastGroup.noFood[, c], levels = reflevels[[c]])
}

# Then round to nice significant digits.
for (c in colnames(bin.per.contrastGroup.noFood) ) {
  if ( is.numeric(bin.per.contrastGroup.noFood[, c]) && abs(range(bin.per.contrastGroup.noFood[, c], na.rm = TRUE)[2]) < 1) {
    bin.per.contrastGroup.noFood[, c] <- signif(bin.per.contrastGroup.noFood[, c], digits = 3)
  } else if (is.numeric(bin.per.contrastGroup.noFood[, c]) && abs(range(bin.per.contrastGroup.noFood[, c], na.rm = TRUE)[2]) > 1) {
    bin.per.contrastGroup.noFood[, c] <- round(bin.per.contrastGroup.noFood[, c], digits = 2)
  }
}

# Set CIs for bins with single feed counts to mean. 
for (r in 1:nrow(bin.per.contrastGroup.noFood)) {
  if (bin.per.contrastGroup.noFood[r, "sum.feed.count"] == 1 || bin.per.contrastGroup.noFood[r, "feeding.fly.count"] == 1) {
    bin.per.contrastGroup.noFood[r, "ci.lower.vol.per.feed.nanoliter"] <- bin.per.contrastGroup.noFood[r, "mean.vol.per.feed.nanoliter"]
    bin.per.contrastGroup.noFood[r, "ci.upper.vol.per.feed.nanoliter"] <- bin.per.contrastGroup.noFood[r, "mean.vol.per.feed.nanoliter"]
    
    bin.per.contrastGroup.noFood[r, "ci.lower.vol.per.feed.per.fly.nanoliter"] <- bin.per.contrastGroup.noFood[r, "mean.vol.per.feed.per.fly.nanoliter"]
    bin.per.contrastGroup.noFood[r, "ci.upper.vol.per.feed.per.fly.nanoliter"] <- bin.per.contrastGroup.noFood[r, "mean.vol.per.feed.per.fly.nanoliter"]
    
    bin.per.contrastGroup.noFood[r, "ci.lower.feed.duration.s"] <- bin.per.contrastGroup.noFood[r, "mean.feed.duration.s"]
    bin.per.contrastGroup.noFood[r, "ci.upper.feed.duration.s"] <- bin.per.contrastGroup.noFood[r, "mean.feed.duration.s"]
    
    bin.per.contrastGroup.noFood[r, "ci.lower.mean.total.feed.count.per.fly"] <- bin.per.contrastGroup.noFood[r, "mean.total.feed.count.per.fly"]
    bin.per.contrastGroup.noFood[r, "ci.upper.mean.total.feed.count.per.fly"] <- bin.per.contrastGroup.noFood[r, "mean.total.feed.count.per.fly"]
    
    bin.per.contrastGroup.noFood[r, "ci.lower.feeding.speed.per.fly.nl.per.s"] <- bin.per.contrastGroup.noFood[r, "mean.feeding.speed.per.fly.nl.per.s"]
    bin.per.contrastGroup.noFood[r, "ci.upper.feeding.speed.per.fly.nl.per.s"] <- bin.per.contrastGroup.noFood[r, "mean.feeding.speed.per.fly.nl.per.s"]
  }
}

# Set CIs that drop below 0, to 0.
for (c in c("ci.lower.vol.per.feed.nanoliter",
            "ci.lower.feeding.speed.nl.per.s",
            "ci.lower.vol.per.feed.per.fly.nanoliter",
            "ci.lower.feeding.speed.per.fly.nl.per.s",
            "ci.lower.feed.duration.s",
            "ci.lower.mean.total.feed.count.per.fly",
            "ci.lower.mean.total.vol.intake.nanoliter",
            "ci.lower.time.to.first.feed.s",
            "ci.lower.feeding.fly.proportion")) {
  bin.per.contrastGroup.noFood[, c][bin.per.contrastGroup.noFood[, c] < 0] <- 0
}

# Turn NAs to '0' for proper plotting.
for ( c in (length(contrast.columns.noFoodType) + 2):ncol(bin.per.contrastGroup.noFood) ) {
  bin.per.contrastGroup.noFood[, c][ is.na(bin.per.contrastGroup.noFood[, c])] <- 0
}

write.csv(bin.per.contrastGroup.noFood, 
          file = paste(output.path, "/bin.per.contrastGroup.noFood.csv", sep = ""), 
          row.names = FALSE)

bin.per.contrastGroup.noFood <- data.frame(bin.per.contrastGroup.noFood)

for (c in contrast.columns.noFoodType) {
  bin.per.contrastGroup.noFood[, c] <- factor(bin.per.contrastGroup.noFood[, c], reflevels[[c]])
  bin.per.contrastGroup.noFood <- arrange_(bin.per.contrastGroup.noFood, c) 
  # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
}

# Create new column in `bin.per.contrastGroup.noFood` to combine all contrasts, without Food.
bin.per.contrastGroup.noFood <- unite_(bin.per.contrastGroup.noFood, "contrast.groups.noFoodType", 
                      contrast.columns.noFoodType, 
                      sep = "\n", 
                      remove = FALSE)

# Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
bin.per.contrastGroup.noFood[, "contrast.groups.noFoodType"] <-  factor(bin.per.contrastGroup.noFood[, "contrast.groups.noFoodType"], 
                                                                        levels.contrast.groups.noFoodType)
# Make sure binned time column is a numeric column.
bin.per.contrastGroup.noFood[, n] <- as.numeric( as.character(bin.per.contrastGroup.noFood[, n]) )
```

```{r HedgesG_withFood, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1) {
  summary.escalc.withFood <- list()
  for (c in contrast.columns) {
    for ( l in levels(summary.per.contrastGroup.withFood[, c]) ) {
      filter_criteria = interp(~ a == b, 
                               .values = list(a = as.name(c), 
                                              b = l))
      temp.df <- droplevels(filter_(summary.per.contrastGroup.withFood, .dots = filter_criteria))  
      temp.ref <-  paste(ref.levels[ , -which(names(ref.levels) %in% c(c))], collapse = "\t")
      t <- dplyr::select(temp.df, one_of(contrast.columns[!contrast.columns %in% c(c)]))
      t <- dplyr::mutate(t, x = apply(t, 1, paste, collapse = "\t"))
      temp.df[, "tempContrast"] <- as.factor(t$x)
      
      # column for contrastGroups.withFoodType.
      # paste the contrast.columns from temp.df together!
      cols <- unique(c(contrast.columns, "FoodType"))
      dots <- lapply(cols, as.symbol)
#       temp.df[, "contrast.groups.withFoodType"] <- factor( apply(select_(temp.df, .dots = dots), 
#                                                                  1, paste, collapse = "\t"),
#                                                            levels = levels.contrast.groups.withFoodType)
      
      # Set reference levels.
      temp.non.ref.levels <- levels(temp.df[, "tempContrast"])[!levels(temp.df[, "tempContrast"]) %in% temp.ref]
      temp.df[, "tempContrast"] <- factor(temp.df[, "tempContrast"])
      temp.df <- arrange(temp.df, contrast.groups.withFoodType) # Do not sort after this line!!
      
      # Reformats temp.df so that all pairwise combinations are in paired rows. 
      # See https://www.biostars.org/p/3694/
      temp.df <- data.frame( apply(temp.df, 2, combn, m = 2) )
      for (i in (length(contrast.columns) + 3) : (ncol(temp.df) - 1) ) {
        temp.df[, i] <- as.numeric( as.character(temp.df[, i]) )
      }

      for ( i in seq(from = 1, to = nrow(temp.df), by = 2) ) {
        # Feed Count
        feed.count.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                    m1i = mean.total.feed.count.per.fly[i + 1], 
                                    m2i = mean.total.feed.count.per.fly[i], 
                                    n1i = total.fly.count[i + 1], n2i = total.fly.count[i],
                                    sd1i = sd.total.feed.count.per.fly[i + 1], 
                                    sd2i = sd.total.feed.count.per.fly[i], append = FALSE)
        feed.count.escalc <- summary.escalc(feed.count.escalc)
        feed.count.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(feed.count.escalc) <- c("average.total.feed.count.per.fly.g", 
                                         "average.total.feed.count.per.fly.var", 
                                         "average.total.feed.count.per.fly.sei", 
                                         "average.total.feed.count.per.fly.zi", 
                                         "average.total.feed.count.per.fly.ci.lb",
                                         "average.total.feed.count.per.fly.ci.ub", 
                                         "comparison")
        
        # Time to first feed
        time.to.first.feed.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                    m1i = mean.time.to.first.feed.s[i + 1], 
                                    m2i = mean.time.to.first.feed.s[i], 
                                    n1i = total.fly.count[i + 1], n2i = total.fly.count[i],
                                    sd1i = sd.time.to.first.feed.s[i + 1], 
                                    sd2i = sd.time.to.first.feed.s[i], append = FALSE)
        time.to.first.feed.escalc <- summary.escalc(time.to.first.feed.escalc)
        time.to.first.feed.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(time.to.first.feed.escalc) <- c("average.time.first.feed.per.fly.g", 
                                         "average.time.first.feed.per.fly.var", 
                                         "average.time.first.feed.per.fly.sei", 
                                         "average.time.first.feed.per.fly.zi", 
                                         "average.time.first.feed.per.fly.ci.lb",
                                         "average.time.first.feed.per.fly.ci.ub", 
                                         "comparison")
        
        # Volume Intake
        vol.intake.nanoliter.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                        m1i = mean.total.vol.intake.nanoliter[i + 1], 
                                        m2i = mean.total.vol.intake.nanoliter[i], 
                                        n1i = total.fly.count[i + 1], 
                                        n2i = total.fly.count[i],
                                        sd1i = sd.mean.total.vol.intake.nanoliter[i + 1], 
                                        sd2i = sd.mean.total.vol.intake.nanoliter[i], append = FALSE)
        vol.intake.nanoliter.escalc <- summary.escalc(vol.intake.nanoliter.escalc)
        vol.intake.nanoliter.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(vol.intake.nanoliter.escalc) <- c("average.total.vol.intake.nanoliter.g", 
                                             "average.total.vol.intake.nanoliter.var", 
                                             "average.total.vol.intake.nanoliter.sei", 
                                             "average.total.vol.intake.nanoliter.zi", 
                                             "average.total.vol.intake.nanoliter.ci.lb",
                                             "average.total.vol.intake.nanoliter.ci.ub", 
                                             "comparison")
        # Volume per Feed
        vol.per.feed.per.fly.nanoliter.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                                        m1i = mean.vol.per.feed.per.fly.nanoliter[i + 1], 
                                                        m2i = mean.vol.per.feed.per.fly.nanoliter[i], 
                                                        n1i = feeding.fly.count[i + 1], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                                        n2i = feeding.fly.count[i], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                                        sd1i = sd.vol.per.feed.per.fly.nanoliter[i + 1], 
                                                        sd2i = sd.vol.per.feed.per.fly.nanoliter[i], append = FALSE)
        vol.per.feed.per.fly.nanoliter.escalc <- summary.escalc(vol.per.feed.per.fly.nanoliter.escalc)
        vol.per.feed.per.fly.nanoliter.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(vol.per.feed.per.fly.nanoliter.escalc) <- c("average.vol.per.feed.per.fly.nanoliter.g", 
                                                             "average.vol.per.feed.per.fly.nanoliter.var", 
                                                             "average.vol.per.feed.per.fly.nanoliter.sei", 
                                                             "average.vol.per.feed.per.fly.nanoliter.zi", 
                                                             "average.vol.per.feed.per.fly.nanoliter.ci.lb",
                                                             "average.vol.per.feed.per.fly.nanoliter.ci.ub", 
                                                             "comparison")
        
        # Feeding Speed
        mean.feeding.speed.per.fly.nl.per.s.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                                             m1i = mean.feeding.speed.per.fly.nl.per.s[i + 1], 
                                                             m2i = mean.feeding.speed.per.fly.nl.per.s[i], 
                                                             n1i = feeding.fly.count[i + 1], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                                             n2i = feeding.fly.count[i], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                                             sd1i = sd.feeding.speed.per.fly.nl.per.s[i + 1], 
                                                             sd2i = sd.feeding.speed.per.fly.nl.per.s[i], append = FALSE)
        mean.feeding.speed.per.fly.nl.per.s.escalc <- summary.escalc(mean.feeding.speed.per.fly.nl.per.s.escalc)
        mean.feeding.speed.per.fly.nl.per.s.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(mean.feeding.speed.per.fly.nl.per.s.escalc) <- c("average.feeding.speed.per.fly.nl.per.s.g", 
                                                                  "average.feeding.speed.per.fly.nl.per.s.var", 
                                                                  "average.feeding.speed.per.fly.nl.per.s.sei", 
                                                                  "average.feeding.speed.per.fly.nl.per.s.zi", 
                                                                  "average.feeding.speed.per.fly.nl.per.s.ci.lb",
                                                                  "average.feeding.speed.per.fly.nl.per.s.ci.ub", 
                                                                  "comparison")
        
        # Proportion of Flies Feeding
        proportion.of.flies.feeding.escalc <- escalc(data = temp.df, measure = "RR", 
                                                     ai = feeding.fly.count[i + 1],
                                                     bi = total.fly.count[i + 1] - feeding.fly.count[i + 1],
                                                     #n1i = total.fly.count[i + 1],
                                                     ci = feeding.fly.count[i],
                                                     di = total.fly.count[i] - feeding.fly.count[i],
                                                     #n2i = total.fly.count[i], 
                                                     append = FALSE)
        proportion.of.flies.feeding.escalc <- summary.escalc(proportion.of.flies.feeding.escalc)
        proportion.of.flies.feeding.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        colnames(proportion.of.flies.feeding.escalc) <- c("proportion.of.flies.feeding.rr", 
                                                          "log.proportion.of.flies.feeding.rr.var", 
                                                          "log.proportion.of.flies.feeding.rr.sei", 
                                                          "log.proportion.of.flies.feeding.rr.zi", 
                                                          "proportion.of.flies.feeding.rr.ci.lb",
                                                          "proportion.of.flies.feeding.rr.ci.ub", 
                                                          "comparison")
        # Convert log risk ratio to original scale.
        for (col in c(1, 5, 6)) {
          proportion.of.flies.feeding.escalc[col] <- exp(proportion.of.flies.feeding.escalc[col])
        }
        
        # Feed Duration
        feed.duration.s.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                          m1i = mean.feed.duration.s[i + 1], 
                                          m2i = mean.feed.duration.s[i], 
                                          n1i = total.fly.count[i + 1], 
                                          n2i = total.fly.count[i],
                                          sd1i = sd.feed.duration.s[i + 1], 
                                          sd2i = sd.feed.duration.s[i], append = FALSE)
        feed.duration.s.escalc <- summary.escalc(feed.duration.s.escalc)
        
        ## Note the underscores for `unite`!
        feed.duration.s.escalc$contrast.group.1 <- unite_(temp.df[i,], "contrast.group.1", contrast.columns, sep = "\n")[, "contrast.group.1"]
        feed.duration.s.escalc$contrast.group.2 <- unite_(temp.df[i + 1,], "contrast.group.2", contrast.columns, sep = "\n")[, "contrast.group.2"]
        feed.duration.s.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
        feed.duration.s.escalc$fixed.factor <- c
        feed.duration.s.escalc$fixed.factor.level <- l
        feed.duration.s.escalc$contrast.factor <- paste(contrast.columns[!contrast.columns %in% c(c)], collapse = ", ")
        feed.duration.s.escalc$contrast.factor.reference.level <- temp.df$tempContrast[i]
        feed.duration.s.escalc$contrast.factor.tested.level <- temp.df$tempContrast[i + 1]
        
        colnames(feed.duration.s.escalc) <- c("average.feed.duration.s.g", 
                                               "average.feed.duration.s.var", 
                                               "average.feed.duration.s.sei", 
                                               "average.feed.duration.s.zi", 
                                               "average.feed.duration.s.ci.lb",
                                               "average.feed.duration.s.ci.ub", 
                                               "contrast.group.1",
                                               "contrast.group.2",
                                               "comparison", 
                                               "fixed.factor", 
                                               "fixed.factor.level",
                                               "contrast.factor", 
                                               "contrast.factor.reference.level", 
                                               "contrast.factor.tested.level")
        #feed.duration.s.escalc[, "contrast.groups.withFoodType"] <- temp.df[, "contrast.groups.withFoodType"][i + 1]
        
        
        x <- full_join(feed.duration.s.escalc, 
                       full_join(vol.per.feed.per.fly.nanoliter.escalc, 
                                 full_join(feed.count.escalc, 
                                           full_join(time.to.first.feed.escalc,
                                                     full_join(mean.feeding.speed.per.fly.nl.per.s.escalc,
                                                               vol.intake.nanoliter.escalc, 
                                                               by = "comparison"), 
                                                     by = "comparison"), 
                                           by = "comparison"), 
                                 by = "comparison"),
                       by = "comparison")
        
        summary.escalc.withFood[[paste(x$comparison)]] <- x[,c(7:14, 1:6, 15:length(x))]
      }
    }
  }
  
  hedges.g.withFood <- do.call('rbind', summary.escalc.withFood)
  hedges.g.withFood[, "comparison"] <- NULL
  rownames(hedges.g.withFood) <- NULL
  
  # Make sure contrast.groups.withFoodType is a factor with appropriate factor levels and order.
#   for (c in c("contrast.group.1", "contrast.group.2")) {
#     hedges.g.withFood[, c] <- factor( hedges.g.withFood[, c],
#                                       levels = levels.contrast.groups.withFoodType )
#   }

  
  # To ensure that fixed.factor.level has the same level order as reflevels!
  all.levels <- c()
  for (r in names(reflevels)) {
    all.levels <- append(all.levels, reflevels[[r]])
  }
  
  hedges.g.withFood[, "fixed.factor.level"] <- factor(hedges.g.withFood[, "fixed.factor.level"], levels = all.levels)
  hedges.g.withFood[, "contrast.group.1"] <- factor(hedges.g.withFood[, "contrast.group.1"], levels = levels.contrast.groups.withFoodType)
  hedges.g.withFood[, "contrast.group.2"] <- factor(hedges.g.withFood[, "contrast.group.2"], levels = levels.contrast.groups.withFoodType)

    # Then round to nice significant digits.
  for (c in colnames(hedges.g.withFood) ) {
    if ( is.numeric(hedges.g.withFood[, c]) && 
         abs(range(hedges.g.withFood[, c], na.rm = TRUE)[2]) < 1) {
      hedges.g.withFood[, c] <- signif(hedges.g.withFood[, c], digits = 3)
    } else if (is.numeric(hedges.g.withFood[, c]) && 
               abs(range(hedges.g.withFood[, c], na.rm = TRUE)[2]) > 1) {
      hedges.g.withFood[, c] <- round(hedges.g.withFood[, c], digits = 2)
    }
  }
  
  # If the comparison is an auto-comparison, set the CIs to zero.
  for (r in 1:nrow(hedges.g.withFood)) {
    if ( identical(hedges.g.withFood[r, "contrast.factor.reference.level"], hedges.g.withFood[r, "contrast.factor.tested.level"] ) ) {
      hedges.g.withFood[r, c(12,13,
                             18,19,
                             24,25,
                             30,31,
                             36,37)] <- 0
    }
  }
  
  
  # Removes comparisons between the same reference levels, for nice-looking tables
  hedges.g.withFood.forTable <- hedges.g.withFood[ !(hedges.g.withFood[, "contrast.group.1"] == hedges.g.withFood[, "contrast.group.2"]), ]
  
  write.csv(hedges.g.withFood.forTable, file = paste(output.path, "/hedges.g.withFood.csv", sep = ""), row.names = FALSE)
}

```

```{r HedgesG_noFood, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
summary.escalc.noFood <- list()
summary.per.contrastGroup.noFood <- arrange_(summary.per.contrastGroup.noFood, contrast.columns.noFoodType)
ref.levels.noFoodType <- ref.levels[!names(ref.levels) %in% c("FoodType")]
for (c in contrast.columns.noFoodType) {
  for ( l in levels(summary.per.contrastGroup.noFood[, c]) ) {
    filter_criteria = interp(~ a == b, 
                             .values = list(a = as.name(c), 
                                            b = l))
    temp.df <- droplevels(filter_(summary.per.contrastGroup.noFood, .dots = filter_criteria))  
    temp.ref <-  paste(ref.levels.noFoodType[ , -which(names(ref.levels.noFoodType) %in% c(c))], collapse = "\n")
    t <- dplyr::select(temp.df, one_of(contrast.columns.noFoodType[!contrast.columns.noFoodType %in% c(c)]))
    t <- dplyr::mutate(t, x = apply(t, 1, paste, collapse = "\n"))
    temp.df[, "tempContrast"] <- as.factor(t$x)
    
    cols <- contrast.columns.noFoodType
    dots <- lapply(cols, as.symbol)

    # Set reference levels.
    temp.non.ref.levels <- levels(temp.df[, "tempContrast"])[!levels(temp.df[, "tempContrast"]) %in% temp.ref]
    temp.df[, "tempContrast"] <- factor(temp.df[, "tempContrast"]) 
    temp.df <- arrange(temp.df, contrast.groups.noFoodType) # Do not sort after this line!!
    
    # Reformats temp.df so that all pairwise combinations are in paired rows. 
    # See https://www.biostars.org/p/3694/
    temp.df <- data.frame( apply(temp.df, 2, combn, m = 2) )
    for (i in (length(contrast.columns.noFoodType) + 2) : (ncol(temp.df) - 1) ) {
      temp.df[, i] <- as.numeric( as.character(temp.df[, i]) )
    }
    
    for ( i in seq(from = 1, to = nrow(temp.df), by = 2) )  {
      # Feed Count
      feed.count.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                  m1i = mean.total.feed.count.per.fly[i + 1], 
                                  m2i = mean.total.feed.count.per.fly[i], 
                                  n1i = total.fly.count[i + 1], n2i = total.fly.count[i],
                                  sd1i = sd.total.feed.count.per.fly[i + 1], 
                                  sd2i = sd.total.feed.count.per.fly[i], append = FALSE)
      feed.count.escalc <- summary.escalc(feed.count.escalc)
      feed.count.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(feed.count.escalc) <- c("average.total.feed.count.per.fly.g", 
                                       "average.total.feed.count.per.fly.var", 
                                       "average.total.feed.count.per.fly.sei", 
                                       "average.total.feed.count.per.fly.zi", 
                                       "average.total.feed.count.per.fly.ci.lb",
                                       "average.total.feed.count.per.fly.ci.ub", 
                                       "comparison")
      
      # Time to first feed
      time.to.first.feed.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                          m1i = mean.time.to.first.feed.s[i + 1], 
                                          m2i = mean.time.to.first.feed.s[i], 
                                          n1i = total.fly.count[i + 1], n2i = total.fly.count[i],
                                          sd1i = sd.time.to.first.feed.s[i + 1], 
                                          sd2i = sd.time.to.first.feed.s[i], append = FALSE)
      time.to.first.feed.escalc <- summary.escalc(time.to.first.feed.escalc)
      time.to.first.feed.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(time.to.first.feed.escalc) <- c("average.time.first.feed.per.fly.g", 
                                               "average.time.first.feed.per.fly.var", 
                                               "average.time.first.feed.per.fly.sei", 
                                               "average.time.first.feed.per.fly.zi", 
                                               "average.time.first.feed.per.fly.ci.lb",
                                               "average.time.first.feed.per.fly.ci.ub", 
                                               "comparison")
      
      # Volume Intake
      vol.intake.nanoliter.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                      m1i = mean.total.vol.intake.nanoliter[i + 1], 
                                      m2i = mean.total.vol.intake.nanoliter[i], 
                                      n1i = total.fly.count[i + 1], 
                                      n2i = total.fly.count[i],
                                      sd1i = sd.mean.total.vol.intake.nanoliter[i + 1], 
                                      sd2i = sd.mean.total.vol.intake.nanoliter[i], append = FALSE)
      vol.intake.nanoliter.escalc <- summary.escalc(vol.intake.nanoliter.escalc)
      vol.intake.nanoliter.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(vol.intake.nanoliter.escalc) <- c("average.total.vol.intake.nanoliter.g", 
                                           "average.total.vol.intake.nanoliter.var", 
                                           "average.total.vol.intake.nanoliter.sei", 
                                           "average.total.vol.intake.nanoliter.zi", 
                                           "average.total.vol.intake.nanoliter.ci.lb",
                                           "average.total.vol.intake.nanoliter.ci.ub", 
                                           "comparison")
      # Volume per Feed
      vol.per.feed.per.fly.nanoliter.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                        m1i = mean.vol.per.feed.per.fly.nanoliter[i + 1], 
                                        m2i = mean.vol.per.feed.per.fly.nanoliter[i], 
                                        n1i = feeding.fly.count[i + 1], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                        n2i = feeding.fly.count[i], # NOTE THE CHANGE FROM TOTAL FLY COUNT TO FEEDING FLY COUNT.
                                        sd1i = sd.vol.per.feed.per.fly.nanoliter[i + 1], 
                                        sd2i = sd.vol.per.feed.per.fly.nanoliter[i], append = FALSE)
      vol.per.feed.per.fly.nanoliter.escalc <- summary.escalc(vol.per.feed.per.fly.nanoliter.escalc)
      vol.per.feed.per.fly.nanoliter.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(vol.per.feed.per.fly.nanoliter.escalc) <- c("average.vol.per.feed.per.fly.nanoliter.g", 
                                             "average.vol.per.feed.per.fly.nanoliter.var", 
                                             "average.vol.per.feed.per.fly.nanoliter.sei", 
                                             "average.vol.per.feed.per.fly.nanoliter.zi", 
                                             "average.vol.per.feed.per.fly.nanoliter.ci.lb",
                                             "average.vol.per.feed.per.fly.nanoliter.ci.ub", 
                                             "comparison")
      
      # Feeding Speed
      mean.feeding.speed.per.fly.nl.per.s.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                                           m1i = mean.feeding.speed.per.fly.nl.per.s[i + 1], 
                                                           m2i = mean.feeding.speed.per.fly.nl.per.s[i], 
                                                           n1i = feeding.fly.count[i + 1], 
                                                           n2i = feeding.fly.count[i],
                                                           sd1i = sd.feeding.speed.per.fly.nl.per.s[i + 1], 
                                                           sd2i = sd.feeding.speed.per.fly.nl.per.s[i], append = FALSE)
      mean.feeding.speed.per.fly.nl.per.s.escalc <- summary.escalc(mean.feeding.speed.per.fly.nl.per.s.escalc)
      mean.feeding.speed.per.fly.nl.per.s.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(mean.feeding.speed.per.fly.nl.per.s.escalc) <- c("average.feeding.speed.per.fly.nl.per.s.g", 
                                                                "average.feeding.speed.per.fly.nl.per.s.var", 
                                                                "average.feeding.speed.per.fly.nl.per.s.sei", 
                                                                "average.feeding.speed.per.fly.nl.per.s.zi", 
                                                                "average.feeding.speed.per.fly.nl.per.s.ci.lb",
                                                                "average.feeding.speed.per.fly.nl.per.s.ci.ub", 
                                                                "comparison")
      
      # Proportion of Flies Feeding
      proportion.of.flies.feeding.escalc <- escalc(data = temp.df, measure = "RR", 
                                                   ai = feeding.fly.count[i + 1],
                                                   bi = total.fly.count[i + 1] - feeding.fly.count[i + 1],
                                                   #n1i = total.fly.count[i + 1],
                                                   ci = feeding.fly.count[i],
                                                   di = total.fly.count[i] - feeding.fly.count[i],
                                                   #n2i = total.fly.count[i], 
                                                   append = FALSE)
      proportion.of.flies.feeding.escalc <- summary.escalc(proportion.of.flies.feeding.escalc)
      proportion.of.flies.feeding.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      colnames(proportion.of.flies.feeding.escalc) <- c("proportion.of.flies.feeding.rr", 
                                                        "log.proportion.of.flies.feeding.rr.var", 
                                                        "log.proportion.of.flies.feeding.rr.sei", 
                                                        "log.proportion.of.flies.feeding.rr.zi", 
                                                        "proportion.of.flies.feeding.rr.ci.lb",
                                                        "proportion.of.flies.feeding.rr.ci.ub", 
                                                        "comparison")
      # Convert log risk ratio to original scale.
      for (col in c(1, 5, 6)) {
        proportion.of.flies.feeding.escalc[col] <- exp(proportion.of.flies.feeding.escalc[col])
      }
      
      # Feed Duration
      feed.duration.s.escalc <- escalc(data = temp.df, measure = "SMD", vtype = "UB", 
                                        m1i = mean.feed.duration.s[i + 1], 
                                        m2i = mean.feed.duration.s[i], 
                                        n1i = total.fly.count[i + 1], 
                                        n2i = total.fly.count[i],
                                        sd1i = sd.feed.duration.s[i + 1], 
                                        sd2i = sd.feed.duration.s[i], append = FALSE)
      feed.duration.s.escalc <- summary.escalc(feed.duration.s.escalc)
      ## Note the underscores for `unite`!
      feed.duration.s.escalc$contrast.group.1 <- unite_(temp.df[i,], "contrast.group.1", contrast.columns.noFoodType, sep = "\n")[, "contrast.group.1"]
      feed.duration.s.escalc$contrast.group.2 <- unite_(temp.df[i + 1,], "contrast.group.2", contrast.columns.noFoodType, sep = "\n")[, "contrast.group.2"]
      feed.duration.s.escalc$comparison <- paste(l, "\t", temp.df$tempContrast[i], " vs ", l, "\t", temp.df$tempContrast[i + 1], sep = "")
      feed.duration.s.escalc$fixed.factor <- c
      feed.duration.s.escalc$fixed.factor.level <- l
      feed.duration.s.escalc$contrast.factor <- paste(contrast.columns.noFoodType[!contrast.columns.noFoodType %in% c(c)], collapse = ", ")
      feed.duration.s.escalc$contrast.factor.reference.level <- temp.df$tempContrast[i]
      feed.duration.s.escalc$contrast.factor.tested.level <- temp.df$tempContrast[i + 1]
      
      colnames(feed.duration.s.escalc) <- c("average.feed.duration.s.g", 
                                             "average.feed.duration.s.var", 
                                             "average.feed.duration.s.sei", 
                                             "average.feed.duration.s.zi", 
                                             "average.feed.duration.s.ci.lb",
                                             "average.feed.duration.s.ci.ub", 
                                             "contrast.group.1",
                                             "contrast.group.2",
                                             "comparison", 
                                             "fixed.factor", 
                                             "fixed.factor.level",
                                             "contrast.factor", 
                                             "contrast.factor.reference.level", 
                                             "contrast.factor.tested.level")
      #feed.duration.s.escalc[, "contrast.groups.noFoodType"] <- temp.df[, "contrast.groups.noFoodType"][i]
      
      x <- full_join(feed.duration.s.escalc, 
                     full_join(vol.per.feed.per.fly.nanoliter.escalc, 
                               full_join(feed.count.escalc, 
                                         full_join(time.to.first.feed.escalc,
                                                   full_join(mean.feeding.speed.per.fly.nl.per.s.escalc,
                                                             vol.intake.nanoliter.escalc, 
                                                             by = "comparison"),
                                                   by = "comparison"), 
                                         by = "comparison"),
                               by = "comparison"), 
                     by = "comparison")

              
      summary.escalc.noFood[[paste(x$comparison)]] <- x[,c(7:14, 1:6, 15:length(x))]
    }
  }
}

hedges.g.noFood <- do.call('rbind', summary.escalc.noFood)
rownames(hedges.g.noFood) <- NULL
hedges.g.noFood[, "comparison"] <- NULL

# Make sure contrast.groups.withFoodType is a factor with appropriate factor levels and order.
# hedges.g.noFood[, "contrast.groups.noFoodType"] <- factor( hedges.g.noFood[, "contrast.groups.noFoodType"] ,
#                                                                levels = levels.contrast.groups.noFoodType )

# To ensure that fixed.factor.level has the same level order as reflevels!
all.levels <- c()
for (r in names(reflevels)) {
  all.levels <- append(all.levels, reflevels[[r]])
}
hedges.g.noFood[, "fixed.factor.level"] <- factor(hedges.g.noFood[, "fixed.factor.level"], levels = all.levels)
hedges.g.noFood[, "contrast.group.1"] <- factor(hedges.g.noFood[, "contrast.group.1"], levels = levels.contrast.groups.noFoodType)
hedges.g.noFood[, "contrast.group.2"] <- factor(hedges.g.noFood[, "contrast.group.2"], levels = levels.contrast.groups.noFoodType)
# Then round to nice significant digits.
for (c in colnames(hedges.g.noFood) ) {
  if ( is.numeric(hedges.g.noFood[, c]) && abs(range(hedges.g.noFood[, c], na.rm = TRUE)[2]) < 1) {
    hedges.g.noFood[, c] <- signif(hedges.g.noFood[, c], digits = 3)
  } else if (is.numeric(hedges.g.noFood[, c]) && abs(range(hedges.g.noFood[, c], na.rm = TRUE)[2]) > 1) {
    hedges.g.noFood[, c] <- round(hedges.g.noFood[, c], digits = 2)
  }
}

# If the comparison is an auto-comparison, set the CIs to zero.
for (r in 1:nrow(hedges.g.noFood)) {
  if ( identical(hedges.g.noFood[r, "contrast.factor.reference.level"], hedges.g.noFood[r, "contrast.factor.tested.level"] ) ) {
    hedges.g.noFood[r, c(12,13,
                           18,19,
                           24,25,
                           30,31,
                           36,37)] <- 0
  }
}

# Removes comparisons between the same reference levels, for good-looking tables.
hedges.g.noFood.forTable <- hedges.g.noFood[ !(hedges.g.noFood[, "contrast.group.1"] == hedges.g.noFood[, "contrast.group.2"]), ]
  
# Write to file.
write.csv(hedges.g.noFood.forTable, file = paste(output.path, "/hedges.g.noFood.csv", sep = ""), row.names = FALSE)
```

```{r PIPerFly, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  cols <- unique(c(contrast.columns.noFoodType, "FlyID")) # Need to group_by FoodType, regardless of whether it is a contrast factor or not.
  dots <- lapply(cols, as.symbol)

    for ( i in 2:length(reflevels$FoodType) ) {
    pi.per.fly <-
      summary.per.fly %>%
      group_by_(.dots = dots) %>%
      summarise(food.choice = FoodType[i],
                pi.feed.count = (total.feed.count[i] - total.feed.count[1]) / 
                  sum(total.feed.count, na.rm = TRUE),
                
                pi.total.vol.intake.nanoliter = (total.vol.intake.nanoliter[i] - total.vol.intake.nanoliter[1]) / 
                  sum(total.vol.intake.nanoliter, na.rm = TRUE),
                
                pi.total.feed.duration.s = (total.feed.duration.s[i] - total.feed.duration.s[1]) / 
                  sum(total.feed.duration.s, na.rm = TRUE) )
  }
  
  for (c in c("pi.feed.count", 
              "pi.total.vol.intake.nanoliter", 
              "pi.total.feed.duration.s")) {
    pi.per.fly[, c] <- round(pi.per.fly[, c], digits = 2)
  }
  
  write.csv(pi.per.fly, file = paste(output.path, "/pi.per.fly.csv", sep = ""), row.names = FALSE)
  pi.per.fly <- data.frame(pi.per.fly)
  
  for (c in contrast.columns.noFoodType) {
    pi.per.fly[, c] <- factor(pi.per.fly[, c], reflevels[[c]])
    pi.per.fly <- arrange_(pi.per.fly, c) 
  }
    # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
    
    # Create new column in `pi.per.fly` to combine all contrasts, without Food.
    pi.per.fly <- unite_(pi.per.fly, "contrast.groups.noFoodType", 
                         contrast.columns.noFoodType, 
                         sep = "\n", 
                         remove = FALSE)
    # Set order of levels of combined contrast groups, according to that dictated in `reference_levels.txt` and in `reflevels`.
    pi.per.fly[, "contrast.groups.noFoodType"] <-  factor(pi.per.fly[, "contrast.groups.noFoodType"], 
                                                          levels.contrast.groups.noFoodType)
}
```

```{r AveragePiPerContrastGroup, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  average.pi.per.contrastGroup <- list()
  
  cols <- c(contrast.columns.noFoodType, "food.choice")
  dots <- lapply(cols, as.symbol)

  for ( i in 2:length(reflevels$FoodType) ) {

    average.pi.per.contrastGroup <-
      pi.per.fly %>%
      group_by_(.dots = dots) %>%
      summarise(average.pi.feed.count = mean(pi.feed.count, na.rm = TRUE),
                
                sd.pi.feed.count = sd(pi.feed.count, na.rm = TRUE),
                
                ci.lower.pi.feed.count = average.pi.feed.count - 
                  1.96 * ( sd.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ),
                
                ci.upper.pi.feed.count = average.pi.feed.count + 
                  1.96 * ( sd.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ),
                
                average.pi.feed.count = mean(pi.feed.count, na.rm = TRUE),
                
                sd.pi.feed.count = sd(pi.feed.count, na.rm = TRUE),
                
                ci.lower.pi.feed.count = average.pi.feed.count - 
                  1.96 * ( sd.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ),
                
                ci.upper.pi.feed.count = average.pi.feed.count + 
                  1.96 * ( sd.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ),
                
                average.pi.total.vol.intake.nanoliter = mean(pi.total.vol.intake.nanoliter, na.rm = TRUE),
                
                sd.pi.total.vol.intake.nanoliter = sd(pi.total.vol.intake.nanoliter, na.rm = TRUE),
                
                ci.lower.pi.feed.count = average.pi.total.vol.intake.nanoliter - 
                  1.96 * ( sd.pi.total.vol.intake.nanoliter / sqrt(length(na.exclude(pi.total.vol.intake.nanoliter))) ),
                
                ci.upper.pi.feed.count = average.pi.total.vol.intake.nanoliter + 
                  1.96 * ( sd.pi.total.vol.intake.nanoliter / sqrt(length(na.exclude(pi.total.vol.intake.nanoliter))) ),
                
                average.pi.total.feed.duration.s = mean(pi.total.feed.duration.s, na.rm = TRUE),
                
                sd.pi.total.feed.duration.s = sd(pi.total.feed.duration.s, na.rm = TRUE),
                
                ci.lower.pi.feed.count = average.pi.total.feed.duration.s - 
                  1.96 * ( sd.pi.total.feed.duration.s / sqrt(length(na.exclude(pi.total.feed.duration.s))) ),
                
                ci.upper.pi.feed.count = average.pi.total.feed.duration.s + 
                  1.96 * ( sd.pi.total.feed.duration.s / sqrt(length(na.exclude(pi.total.feed.duration.s))) ))
    
  }
  
  average.pi.per.contrastGroup = do.call("rbind", average.pi.per.contrastGroup)
  average.pi.per.contrastGroup <- data.frame(average.pi.per.contrastGroup)

  for (c in c( (length(cols) + 1) : ncol(average.pi.per.contrastGroup)) ) {
    average.pi.per.contrastGroup[, c] <- round(average.pi.per.contrastGroup[, c], digits = 2)
  }
  
  write.csv(average.pi.per.contrastGroup, file = paste(output.path, "/average.pi.per.contrastGroup.csv", sep = ""), row.names = FALSE)
}
```

```{r PiPerFlyTimeCourse, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  n <- paste("bin.", as.character(bw/60), ".min", sep = "")
  cols <- unique(c(n, contrast.columns.noFoodType, "FlyID")) 
  dots <- lapply(cols, as.symbol)
  
  # Change all NAs in total.vol.intake.nanoliter and total.feed.duration.s to 0.
  bin.per.fly[, "total.vol.intake.nanoliter"][is.na(bin.per.fly[, "total.vol.intake.nanoliter"])] <- 0
  bin.per.fly[, "total.feed.duration.s"][is.na(bin.per.fly[, "total.feed.duration.s"])] <- 0
  
  for ( i in 2:length(reflevels$FoodType) ) {
    pi.per.fly.time.course <- 
      bin.per.fly %>% 
      group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
      summarise(food.choice = FoodType[i],
                pi.feed.count = (total.feed.count[i] - total.feed.count[1]) / 
                  sum(total.feed.count, na.rm = TRUE),
                
                pi.total.vol.intake.nanoliter = (total.vol.intake.nanoliter[i] - total.vol.intake.nanoliter[1]) / 
                  sum(total.vol.intake.nanoliter, na.rm = TRUE),
                
                pi.total.feed.duration.s = (total.feed.duration.s[i] - total.feed.duration.s[1]) / 
                  sum(total.feed.duration.s, na.rm = TRUE) )
  }
  for (c in c( (length(cols) + 2) : ncol(pi.per.fly.time.course)) ) {
    pi.per.fly.time.course[, c] <- round(pi.per.fly.time.course[, c], digits = 2)
  }
  
  pi.per.fly.time.course <- data.frame(pi.per.fly.time.course)
  write.csv(pi.per.fly.time.course, file = paste(output.path, "/pi.per.fly.time.course.csv", sep = ""), row.names = FALSE)
  
  # Add contrast columns to the dataframe.
  cols2 <- contrast.columns.noFoodType
  dots2 <- lapply(cols2, as.symbol)
  pi.per.fly.time.course[, "contrast.groups.noFoodType"] <- 
    factor( apply( select_(pi.per.fly.time.course, .dots = dots2),1, paste, collapse = "\n"),
            levels = levels.contrast.groups.noFoodType)
  
  # Make sure binned time column is a numeric column.
  pi.per.fly.time.course[, n] <- as.numeric( as.character(pi.per.fly.time.course[, n]) )
}
```

```{r AveragePiPerContrastGroupTimeCourse, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  n <- paste("bin.", as.character(bw/60), ".min", sep = "")
  cols <- unique(c(n, contrast.columns.noFoodType)) 
  dots <- lapply(cols, as.symbol)
  
  average.pi.per.contrastGroup.time.course <- 
    pi.per.fly.time.course %>% 
    group_by_(.dots = dots) %>% # Don't forget the second underscore for non-standard evaluation.
    summarise(average.pi.feed.count = mean(pi.feed.count, na.rm = TRUE),
              sd.average.pi.feed.count = sd(pi.feed.count, na.rm = TRUE),
              ci.lower.average.pi.feed.count = average.pi.feed.count -
                1.96 * ( sd.average.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ), 
              ci.upper.average.pi.feed.count = average.pi.feed.count +
                1.96 * ( sd.average.pi.feed.count / sqrt(length(na.exclude(pi.feed.count))) ), 
              
              average.pi.total.vol.intake.nanoliter = mean(pi.total.vol.intake.nanoliter, na.rm = TRUE),
              sd.average.pi.total.vol.intake.nanoliter = sd(pi.total.vol.intake.nanoliter, na.rm = TRUE),
              ci.lower.average.pi.total.vol.intake.nanoliter = average.pi.total.vol.intake.nanoliter -
                1.96 * ( sd.average.pi.total.vol.intake.nanoliter / sqrt(length(na.exclude(pi.total.vol.intake.nanoliter))) ), 
              ci.upper.average.pi.total.vol.intake.nanoliter = average.pi.total.vol.intake.nanoliter +
                1.96 * ( sd.average.pi.total.vol.intake.nanoliter / sqrt(length(na.exclude(pi.total.vol.intake.nanoliter))) ), 
              
              average.pi.total.feed.duration.s = mean(pi.total.feed.duration.s, na.rm = TRUE),
              sd.average.pi.total.feed.duration.s = sd(pi.total.feed.duration.s, na.rm = TRUE),
              ci.lower.average.pi.total.feed.duration.s = average.pi.total.feed.duration.s -
                1.96 * ( sd.average.pi.total.feed.duration.s / sqrt(length(na.exclude(pi.total.feed.duration.s))) ), 
              ci.upper.average.pi.total.feed.duration.s = average.pi.total.feed.duration.s +
                1.96 * ( sd.average.pi.total.feed.duration.s / sqrt(length(na.exclude(pi.total.feed.duration.s))) ) )
  
  for (c in c( (length(cols) + 1) : ncol(pi.per.fly.time.course)) ) {
    average.pi.per.contrastGroup.time.course[, c] <- round(average.pi.per.contrastGroup.time.course[, c], digits = 2)
  }
  
  average.pi.per.contrastGroup.time.course <- data.frame(average.pi.per.contrastGroup.time.course)
  
  # Set CIs that drop below -1, to -1, and CIs that go above 1, to 1.
  for (c in c("ci.lower.average.pi.feed.count",
              "ci.lower.average.pi.total.vol.intake.nanoliter",
              "ci.lower.average.pi.total.feed.duration.s")) {
    average.pi.per.contrastGroup.time.course[, c][average.pi.per.contrastGroup.time.course[,c] < -1] <- -1
    
  }
  
  for (c in c("ci.upper.average.pi.feed.count",
              "ci.upper.average.pi.total.vol.intake.nanoliter",
              "ci.upper.average.pi.total.feed.duration.s")) {
    average.pi.per.contrastGroup.time.course[, c][average.pi.per.contrastGroup.time.course[,c] > 1] <- 1
  }
  
  # Write to file.
  average.pi.per.contrastGroup.time.course[, n] <- as.numeric(as.character(average.pi.per.contrastGroup.time.course[, n]))
  
  # Add contrast columns to the dataframe.
  cols2 <- contrast.columns.noFoodType
  dots2 <- lapply(cols2, as.symbol)
  average.pi.per.contrastGroup.time.course[, "contrast.groups.noFoodType"] <- 
    factor( apply( select_(average.pi.per.contrastGroup.time.course, .dots = dots2),1, paste, collapse = "\n"),
            levels = levels.contrast.groups.noFoodType)
  
    
  # Make sure binned time column is a numeric column.
  average.pi.per.contrastGroup.time.course[, n] <- as.numeric( as.character(average.pi.per.contrastGroup.time.course[, n]) )
}
```

```{r customContrastColourScale, message = FALSE, error = TRUE, warning = FALSE, echo = FALSE, eval = TRUE}
# Create a custom color scale
# See http://novyden.blogspot.sg/2013/09/how-to-expand-color-palette-with-ggplot.html

# solo.contrast.levels <- c()
# for (c in contrast.columns) {
#   solo.contrast.levels <- append(solo.contrast.levels, levels(rawdata.all[, c]) )
# }

levels.all <- unique(c(levels(rawdata.all[, "contrast.groups.noFoodType"]),
                       levels(rawdata.all[, "contrast.groups.withFoodType"]) ) )

# Choose one of the sets of 2 lines below.
customPalette <-  colorRampPalette( brewer.pal(9, "Set1") ) 
contrast.colours <- customPalette( length(levels.all) )
names(contrast.colours) <- levels.all

# contrast.colours <- rainbow(n = length(levels.all) )
# names(contrast.colours) <- c( levels.all )

# Use the line of code below to check on suitability of palette.
# pie(rep(1,length(levels.all)), labels = levels.all, col = contrast.colours)
contrastColours <- scale_colour_manual(values = contrast.colours)
contrastFills <- scale_fill_manual(values = contrast.colours)

# For more on choosing colours
# http://graphicdesign.stackexchange.com/questions/3682/where-can-i-find-a-large-palette-set-of-contrasting-colors-for-coloring-many-d
# http://stackoverflow.com/questions/7251872/is-there-a-better-color-scale-than-the-rainbow-colormap
```

## Data Summary

Feedlog files analysed: `r paste(list.files(feedlog.path), collapse = "\n")`

```{r DataSummary, message = FALSE, error=FALSE, echo = FALSE, eval = TRUE, results = "asis"}
print("Food type(s) used in experiment(s):")
print( paste(levels(rawdata.all$FoodType), collapse = "; ") )
xtable( contrast.numbers[,-2], caption = "Summary of Experimental Contrasts.")

if ( length(no.feed.flies) > 0 ) {
  print("FlyIDs of flies that did not feed at all (total feed count = 0) for the entire assay duration: ")
  print(as.character(no.feed.flies))
  
  f <- metadata.all[as.numeric(no.feed.flies), c(contrast.columns.noFoodType, "FlyID")]
  xtable(f, caption = "Flies that Did Not Feed.")
}
```

\newpage

## Raster Plot of Feed Events

```{r RasterPlotFeedEvent, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25, fig.width = 18, fig.fullwidth = TRUE, fig.cap = "Raster Plots. A. Individual Raster Plots of Feed Events for each fly. The height of each Feed Event is proportional to the Feed Volume of that Feed. The ID for each fly is labelled on the right. B. Summed Raster Plots of sucrose feeds, and sucrose + arabinose feeds for all flies of that genotype.", results = "hide"}

density.plot.feed.times <- data.frame()
plot.list <- list()

for ( c in levels(rawdata.all[, "contrast.groups.noFoodType"]) ) {
  a <- hist(droplevels(filter(rawdata.all, contrast.groups.noFoodType == c))$FeedStartTimeRelative,
            breaks = seq(0, (h * 3600), by = bs),
            plot = FALSE)
  b <- data.frame(a$breaks[-1], a$counts, a$density,
                  rep(c, length(a$breaks) - 1),
                  rep("All choices", length(a$breaks) - 1))
  colnames(b) <- c("breaks", "counts", "density", "contrast.groups.noFoodType", "FoodType")
  density.plot.feed.times <- rbind(density.plot.feed.times, b)
  
  for ( food in levels(rawdata.all$FoodType) ) {
    a <- hist(droplevels(filter(rawdata.all, contrast.groups.noFoodType == c, FoodType == food))$FeedStartTimeRelative,
              breaks = seq(0, (h * 3600), by = bs),
              plot = FALSE)
    b <- data.frame(a$breaks[-1], a$counts, a$density,
                    rep(c, length(a$breaks) - 1),
                    rep(food, length(a$breaks) - 1))
    colnames(b) <- c("breaks", "counts", "density", "contrast.groups.noFoodType", "FoodType")
    density.plot.feed.times <- rbind(density.plot.feed.times, b)
  }
}

raster.theme <- theme(panel.margin = unit(0, "npc"),
                      strip.text.y = element_text(angle = 0, size = 14),
                      axis.text.x = element_text(size = 14), 
                      axis.text.y = element_text(size = 13), 
                      strip.background = element_blank(),
                      legend.position = "bottom",
                      legend.direction = "horizontal",
                      panel.background = element_rect(fill = "grey97", colour = "white"),
                      plot.margin = unit(c(0, 0, 0, 0), "npc"),
                      plot.title = element_text(size = 16, face = "italic"),
                      axis.title = element_text(size = 16),
                      axis.line.y = element_line(colour = "black", size = 1),
                      panel.grid.major = element_blank())

heatmap.theme <- theme(axis.text.y = element_blank(), 
                       axis.text.x = element_text(size = 14), 
                       axis.ticks.y = element_blank(),
                       axis.line.y = element_blank(),
                       axis.title.x = element_text(size = 13, face = "plain"),
                       strip.text.x = element_text(size = 13, face = "italic"),
                       strip.background = element_rect(fill = "white", colour = "white"),
                       legend.position = "bottom",
                       legend.direction = "horizontal",
                       #axis.ticks.x = element_blank(),
                       axis.ticks.y = element_blank(),
                       panel.grid.major = element_blank(),
                       plot.margin = unit(c(0, 0, 0, 0), "npc"))

for ( c in levels(rawdata.all[, "contrast.groups.noFoodType"]) ) {
  
  a <- ggplot(data = droplevels(filter(rawdata.all, contrast.groups.noFoodType == c)),
              aes(x = FeedStartTimeRelative, y = Volume.nanoliter)) +
    geom_histogram(stat ="identity", aes(colour = FoodType, 
                                         fill = FoodType)) +
    coord_cartesian(ylim = round_any(range(rawdata.all$Volume.nanoliter), 10),
                    xlim = c(0, h * 3600)) +
    scale_x_continuous(breaks = 3600 * (0:h),
                       labels = (0:h)) +
    scale_y_continuous(breaks = round_any(range(rawdata.all$Volume.nanoliter), 10),
                       labels = paste(round_any(range(rawdata.all$Volume.nanoliter), 10), " nl", sep = "") ) +
    scale_colour_manual(values = c("black", "red", "blue", "darkmagenta")) +
    scale_fill_manual(values = c("black", "red", "blue", "darkmagenta")) +
    facet_grid(FlyID ~ .) + xlab("") + ylab("") +
    ggtitle(paste(c, " (n = ", contrast.numbers[c, ], ")", sep ="")) +
    theme_minimal() +
    raster.theme
  
  legend.a <- get_legend(a)
#   g <- ggplotGrob(a)
#   s <- gtable_filter(g, 'axis-l|ylab', trim=F)
#   y.axis.a <- s$grobs[[1]]
  
  a <- a + guides(colour = FALSE, fill = FALSE)
  
  b <- ggplot(data = droplevels(filter(density.plot.feed.times, contrast.groups.noFoodType == c)), 
              aes(breaks, 1)) + 
    facet_wrap(~FoodType, ncol = 1) +
    geom_tile(aes(fill = counts)) + 
    scale_fill_gradient(low = "darkgreen", high = "orange", 
                        limits = (round_any(range(density.plot.feed.times$counts), 10))) +
    ylab("") + xlab(paste("Hours", " (Bin Size = ", bs/60 ," min)", sep = "")) +
    scale_x_continuous(breaks = 3600 * (0:h),
                       labels = (0:h)) + 
    theme_minimal() + heatmap.theme
  
  legend.b <- get_legend(b)
  b <- b + guides(fill = FALSE)
  
  plot.list[[c]] <- plot_grid(a, b, ncol = 1, nrow = 2, align = "h",
                              rel_heights = c(2, 0.8))
  
}

#multiplot(plot.list)
plot.list[["legend.a"]] <- legend.a
plot.list[["legend.b"]] <- legend.b

plot_grid(plotlist = plot.list, 
          ncol = 2, rel_heights = c( rep(6, ceiling( (length(plot.list) - 2) / 2)),
                                    1) )
```

\newpage

## Proportion of Flies Feeding

```{r proportionFliesFeedingStackedBar_TimeCourse, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 12, fig.width = 15, fig.fullwidth = TRUE}
# Extract relevant columns from summary.per.contrastGroup.noFood
prop.feeding <- summary.per.contrastGroup.noFood[, c("contrast.groups.noFoodType",
                                                     "proportion.feeding")]

# Crunch the columns to get the percentage feeding and not feeding
prop.feeding <- mutate(prop.feeding, proportion.not.feeding = 1 - proportion.feeding)

prop.feeding <-
  prop.feeding %>% 
  gather(action, proportion, c(2,3))

prop.feeding[, "contrast.groups.noFoodType"] <- factor(prop.feeding[, "contrast.groups.noFoodType"],
                                                       levels = rev(levels(prop.feeding[, "contrast.groups.noFoodType"])))
summary.per.contrastGroup.noFood <- mutate(summary.per.contrastGroup.noFood, 
                                           prop.feeding.annotation = paste(proportion.feeding * 100, 
                                                                           "%\n[", ci.lower.proportion.feeding * 100, "% - ",
                                                                           ci.upper.proportion.feeding * 100, "%]", sep = ""))
# Produce the stacked barplot.
left <- ggplot() +
  geom_bar(data = prop.feeding,
               aes(x = contrast.groups.noFoodType,
                   y = proportion,
                   fill = action),
           stat = "identity",
           width = 0.25,
           colour = "black") +
  scale_fill_manual(values=c("lightgrey", "white")) +
  geom_linerange(data = summary.per.contrastGroup.noFood,
                 aes(x = contrast.groups.noFoodType,
                     y = proportion.feeding,
                     ymin = ci.lower.proportion.feeding,
                     ymax = ci.upper.proportion.feeding,
                     alpha = 0.9),
                 size = 1.5) +
  geom_text(data = summary.per.contrastGroup.noFood,
                 aes(x = contrast.groups.noFoodType,
                     y = ci.lower.proportion.feeding,
                     label = prop.feeding.annotation,
                     hjust = 1,
                     vjust = 0.5,
                     size = 10) ) +
  scale_y_continuous(labels = percent_format()) +
  theme_classic() +
  ylab('Percent Feeding') +
  xlab('') +
  ggtitle("Proportion of Flies Feeding\nby Contrast Group") +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(size = 17, face = "plain"),
        axis.title = element_text(size = 17, face = "plain"),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype = 3, 
                                          colour = "grey",
                                          size = 1)
        ) +
  guides(colour = FALSE, fill = FALSE, size = FALSE, alpha = FALSE)

# Produce the time course plot
n <- paste("bin.", as.character(bw/60), ".min", sep = "")

right <- ggplot(data = bin.per.contrastGroup.noFood,
                aes_string(x = n,
                           y = "feeding.fly.proportion",
                           colour = "contrast.groups.noFoodType")) +
  geom_ribbon(aes(ymin = ci.lower.feeding.fly.proportion, 
                  ymax = ci.upper.feeding.fly.proportion,
                  fill = contrast.groups.noFoodType),
              linetype = "dotted",
              alpha = 0.15) +
  geom_point(alpha = 0.5, size = 2.75) + 
  geom_path(alpha = 0.5, size = 1.2) +
  contrastColours + contrastFills +
  facet_wrap(~ contrast.groups.noFoodType, ncol = 1, scales = "free_x") +
  geom_hline(yintercept = c(25, 50 ,75), linetype = "dotted") +
  geom_point(size = 5, alpha = 0.7) + geom_line(size = 1.5, alpha = 0.5) +
  scale_y_continuous(labels = percent_format()) + 
  scale_x_continuous(breaks = seq(from = 0, to = h * 3600, by = 3600),
                     labels = seq(from = 0, to = h * 3600, by = 3600) / 3600) +
  coord_cartesian(ylim = c(0, 1)) +
  ylab("Proportion of Flies Feeding") + 
  ggtitle("Time Course of Proportion of Flies Feeding\nBy Contrast Group") +
  xlab( paste("Hours\nBin size = ", as.character(bw/60), " min", sep = "") ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 17, face = "plain"),
        axis.title = element_text(size = 17, face = "plain"),
        axis.text = element_text(size = 15),
        axis.ticks.y = element_blank(),
        strip.text = element_text(size = 15, face = "italic"),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = 3, 
                                          colour = "grey",
                                          size = 1)) +
  guides(fill = FALSE, colour = FALSE)

fig.label <- data.frame(label = "Panel A shows, for each contrast group, the proportion of flies that fed at least once across the entire assay duration. 
The 95% CI for the proportion feeding is indicated by the horizontal line. Panel B shows, for each contrast group, 
how the proportion of flies feeding changes across the assay duration. Each dot represents the proportion at a specific time bin, 
with 95% CIs depicted by the surrounding coloured envelope. ", x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
       panel.border = element_blank(), 
       axis.line = element_blank(), 
       axis.text.x = element_blank(), 
       axis.text.y = element_blank(), 
       axis.ticks = element_blank(), 
       plot.margin = unit(c(-0.5,1, 0, 0.5), "lines") ) + 
  xlab(NULL) + ylab(NULL)

ggdraw() + 
  draw_plot(left, x = 0, y = 0.15, width = .5, height = 0.8) +
  draw_plot(right, x = 0.5, y = 0.15, width = .5, height = 0.8) +
  draw_plot(bottom, x = 0, y = 0, width = 1, height = .2) +
  draw_plot_label(label = c("A", "B", " "), size = 25,
                  x = c(0, 0.5, 0), y = c(0.99, 0.99, 0))
```

\newpage

## Cumulative Volume Drunk Per Fly

```{r CumSumDataPlot, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 20, fig.width = 15, fig.fullwidth = FALSE, fig.cap = "Cumulative Feed Volume per Fly."}
# maxcumsum <- data.frame()
# for (c in levels(rawdata.all[, "FlyID.contrast.groups.withFoodType"]) ) {
#   temp.df <- droplevels( filter(rawdata.all, FlyID.contrast.groups.withFoodType == c) )
#   temp.row <- data.frame(temp.df[1, "FlyID"], 
#                          temp.df[1, "FlyID.contrast.groups.withFoodType"],
#                          temp.df[1, "contrast.groups.withFoodType"],
#                          range(temp.df[, "cumulative.vol.nanoliter"], na.rm =TRUE)[2],
#                          range(temp.df[, "FeedStartTimeRelative"], na.rm =TRUE)[2])
#   colnames(temp.row) <- c("FlyID", "FlyID.contrast.groups.withFoodType", 
#                           "contrast.groups.withFoodType", "maxCumSum", "lastFeedTimeSec")
#   maxcumsum <- rbind(maxcumsum, temp.row)
#   colnames(maxcumsum) <- colnames(temp.row)
# }
# 
# maxcumsum[, "lastFeedTimeSec"][maxcumsum[, "lastFeedTimeSec"] == -Inf] <- (h - 0.5) * 3600

# # Chunk just before ggplot enables display of flies that did not feed at all.
# n <- paste("bin.", as.character(bw/60), ".min", sep = "")
# temp <- rawdata.all
# for (x in 1:nrow(temp)) {
#   if ( is.na(temp[x, "FeedStartTimeRelative"]) && temp[x, "FlyID"] %in% no.feed.flies ) {
#     temp[x, "FeedStartTimeRelative"] <- as.numeric(as.character(temp[x, n]))
#   }
# }

temp <- rawdata.all[ !is.na(rawdata.all[, "FeedStartTimeRelative"]),  ]

ggplot(data = temp, 
       aes(x = FeedStartTimeRelative, 
           y = cumulative.vol.nanoliter, 
           colour = as.factor(FlyID))) +
  guides(colour = FALSE) +
  geom_point(alpha = 0.3, size = 2.75) + 
  geom_path(alpha = 0.3, size = 1.2) + 
  facet_wrap(~ contrast.groups.withFoodType, 
             ncol = 2,
             drop = FALSE) + 
  scale_x_continuous(breaks = 3600 * (-1:h+1),
                     labels = (-1:h+1), 
                     expand = c(0.1, 0)) +
  ggtitle("Cumulative Volume Across Assay Duration Per Fly") +
  theme_minimal() +
  theme(plot.title = element_text(size = 17, face = "bold"),
        axis.title = element_text(size = 17, face = "plain"),
        axis.text = element_text(size = 15),
        strip.text = element_text(size = 15, face = "italic"),
        strip.background = element_rect(fill = "lightgrey", colour = "white"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_line(linetype = 1, 
                                        colour = "grey90",
                                        size = 0.25),
        panel.grid.minor = element_blank()
        ) +
  xlab("Time (hours)") + 
  ylab("Cumulative Volume (nl)")

#   theme(strip.text.x = element_text(size = 14),
#         axis.title = element_text(size = 18),
#         axis.text = element_text(size = 16))

  #   geom_text(data = maxcumsum,
  #             aes(label = FlyID,
  #                 x = lastFeedTimeSec + 2400,
  #                 y = maxCumSum),
  #             size = 7.5,
  #             alpha = 0.8) +

rm(temp)
```

\newpage

## Correlation of Feed Duration and Feed Volume

```{r CorrelateFeedDurationFeedVolume, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = FALSE, fig.cap = "Correlation of Feed Duration and Feed Volume"}
corr <- data.frame()
for (c in levels(rawdata.all[, "contrast.groups.withFoodType"]) ) {
  temp.df <- filter(rawdata.all, contrast.groups.withFoodType == c)
  temp.df <- mutate(temp.df, Duration.s = Duration.s / 1000)
  reg <- lm(data = temp.df, na.action = "na.exclude",
                        formula = Volume.nanoliter ~ Duration.s)
  temp.lm <- summary(reg)
  slope.confint <- signif(as.numeric(confint(reg)[2,]), digits = 2)
  temp.row <- data.frame(c, 
                         paste("slope = ", signif(temp.lm$coefficients[2,1], 3),
                                " [", slope.confint[1], "; ", slope.confint[2], "]",
                               "\nAdj R-squared = ", signif(temp.lm$adj.r.squared, 2),
                               "\nP-value = ", signif(temp.lm$coefficients[2,4], 2),
                               sep = ""),
                         max(temp.df[, "Volume.nanoliter"]) * 0.8)
  colnames(temp.row) <- c("contrast.groups.withFoodType", "annotation", "max.vol")
  corr <- rbind(corr, temp.row)
  colnames(corr) <- colnames(temp.row)
}

max.duration <- max(rawdata.all$Duration.s)
vol.max <- signif( range(rawdata.all$Volume.nanoliter)[2], 2 )

ggplot(data = rawdata.all, 
       aes(x = Duration.s,
           y = Volume.nanoliter)) +
#            colour = contrast.groups.withFoodType,
#            fill = contrast.groups.withFoodType)) +
  coord_cartesian(ylim = c(0, vol.max)) +
  geom_point(aes(alpha = 0.05)) + 
  stat_smooth(method = "lm", fullrange = TRUE) +
  geom_text(data = corr,
            aes(label = annotation,
                x = 0,
                y = vol.max * 0.65), 
            hjust = 0, vjust = 0) +
  facet_wrap(~ contrast.groups.withFoodType, ncol = 2) +
  # contrastColours + contrastFills +
  ylab("Volume of Feed (nl)") + xlab("Duration of Feed (s)") +
  guides(alpha = FALSE) + ggtitle("Correlation of Feed Volume and Feed Duration") +
  theme_minimal() +
  theme(plot.title = element_text(size = 17, face = "bold"),
        axis.title = element_text(size = 17, face = "plain"),
        axis.text = element_text(size = 15),
        strip.background = element_rect(fill = "lightgrey", colour = "white"),
        strip.text = element_text(size = 14, face = "italic"),
#         axis.ticks.x = element_blank(),
#         axis.ticks.y = element_blank(),
        panel.grid.major = element_blank() )

```

\newpage

## Correlation of Average Feed Size Per Fly, and Total Feed Count Per Fly

```{r CorrelateAverageFeedSizePerFly_TotalFeedCountPerFly, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = FALSE, fig.cap = "Correlation of Average Feed Size Per Fly, and Total Feed Count Per Fly. (Does this give an indication of portion size control?"}
corr <- data.frame()
temp.summ <- summary.per.fly
temp.summ[, "mean.vol.per.feed.nanoliter"][is.na(temp.summ[, "mean.vol.per.feed.nanoliter"])] <- 0

for (c in levels(temp.summ[, "contrast.groups.withFoodType"]) ) {
  temp.df <- filter(temp.summ, contrast.groups.withFoodType == c)
  reg <- lm(data = temp.df, na.action = "na.exclude",
                        formula = mean.vol.per.feed.nanoliter ~ total.feed.count)
  temp.lm <- summary(reg)
  slope.confint <- signif(as.numeric(confint(reg)[2,]), digits = 2)
  temp.row <- data.frame(c, 
                         paste("slope = ", signif(temp.lm$coefficients[2,1], 2),
                               " [", slope.confint[1], "; ", slope.confint[2], "]",
                               "\nAdj R-squared = ", signif(temp.lm$adj.r.squared, 2),
                               "\nP-value = ", signif(temp.lm$coefficients[2,4], 2),
                               sep = ""))
  colnames(temp.row) <- c("contrast.groups.withFoodType", "annotation")
  corr <- rbind(corr, temp.row)
  colnames(corr) <- colnames(temp.row)
}

max.vol <- max(temp.summ[, "mean.vol.per.feed.nanoliter"])

ggplot(data = temp.summ, 
       aes(x = total.feed.count,
           y = mean.vol.per.feed.nanoliter)) +
  geom_point(aes(alpha = 0.1)) + 
  stat_smooth(method = "lm", fullrange = TRUE) +
  facet_wrap(~ contrast.groups.withFoodType, 
             scales = "free_x",
             ncol = 2) +
  geom_text(data = corr,
            aes(label = annotation,
                       x = 0,
                       y = max.vol * 0.9), 
            hjust = -0.1, vjust = 0.7) + 
  ylab("Average Feed Size (nl)") + xlab("Total Feed Count") +
  guides(alpha = FALSE) + 
  ggtitle("Correlation of Average Feed Size Per Fly\nand Total Feed Count Per Fly") +
  theme_minimal() +
  theme(plot.title = element_text(size = 17, face = "bold"),
        axis.title = element_text(size = 17, face = "plain"),
        axis.text = element_text(size = 15),
        strip.text = element_text(size = 14, face = "italic"),
        strip.background = element_rect(fill = "lightgrey", colour = "white"),
#         axis.ticks.x = element_blank(),
#         axis.ticks.y = element_blank(),
        panel.grid.major = element_blank() )

```

\newpage

## Time Course -- Preference Index 

Preference Index (Total Feed Count) for `r reflevels[["FoodType"]][2]` is calculated as follows: $$PI_{FeedCount} = \frac{FeedCount_{TestFood} - FeedCount_{RefFood}}{FeedCount_{TestFood} + FeedCount_{RefFood}}$$ Therefore a positive PI indicates a preference for `r reflevels[["FoodType"]][2]`.

The same applies for Total Feed Duration and Total Volume Intake.

```{r piPlot, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25, fig.width = 18, fig.fullwidth = FALSE, results = "hide"}
if ( "FoodType" %in% names(reflevels) ) {
  n <- paste("bin.", as.character(bw/60), ".min", sep = "")

  a <-
    ggplot(data =  average.pi.per.contrastGroup.time.course,
           aes_string(x = n,
                      y = "average.pi.feed.count",
                      colour = "contrast.groups.noFoodType")) + 
    geom_ribbon(aes(ymin = ci.lower.average.pi.feed.count, 
                    ymax = ci.upper.average.pi.feed.count,
                    fill = contrast.groups.noFoodType),
                linetype = "dotted",
                alpha = 0.15) +
    geom_point(alpha = 0.5, size = 2.75) + 
    geom_path(alpha = 0.5, size = 1.2) +
    contrastColours + contrastFills +
    facet_wrap(~ contrast.groups.noFoodType) +
    geom_hline(yintercept = 0, linetype = "dotted", size = 0.8) +
    ylab("Preference Index Feed Count") + xlab("") +
    ggtitle(paste("Preference Indices for ", reflevels$FoodType[2], sep = "")) +
    scale_x_continuous(breaks = seq(from = 0, to = h * 3600, by = 3600),
                       labels = seq(from = 0, to = h * 3600, by = 3600) / 3600) +
    scale_y_continuous(breaks = c(-1, -0.5, 0, 0.5, 1),
                       labels = c("-1", "", "0", "", "1")) +
    coord_cartesian(ylim = c(-1, 1)) + 
    guides(colour = FALSE, fill = FALSE) +
    theme_minimal() +
    theme(plot.title = element_text(size = 17, face = "bold"),
          axis.title = element_text(size = 17, face = "plain"),
          axis.text = element_text(size = 15),
          strip.text = element_text(size = 14, face = "italic"),
          strip.background = element_rect(fill = "lightgrey", colour = "white"),
          #axis.ticks.x = element_blank(),
          #axis.ticks.y = element_blank(),
          panel.grid.major = element_blank() )
  
  
  b <-
    ggplot(data =  average.pi.per.contrastGroup.time.course,
           aes_string(x = n,
                      y = "average.pi.total.vol.intake.nanoliter",
                      colour = "contrast.groups.noFoodType")) + 
    geom_ribbon(aes(ymin = ci.lower.average.pi.total.vol.intake.nanoliter, 
                    ymax = ci.upper.average.pi.total.vol.intake.nanoliter,
                    fill = contrast.groups.noFoodType),
                linetype = "dotted",
                alpha = 0.15) +
    geom_point(alpha = 0.5, size = 2.75) + 
    geom_path(alpha = 0.5, size = 1.2) +
    contrastColours + contrastFills +
    facet_wrap(~ contrast.groups.noFoodType) +
    geom_hline(yintercept = 0, linetype = "dotted", size = 0.8) +
    ylab("Preference Index Volume Intake") + xlab("") +
    ggtitle("   ") +
    scale_x_continuous(breaks = seq(from = 0, to = h * 3600, by = 3600),
                       labels = seq(from = 0, to = h * 3600, by = 3600) / 3600) +
    scale_y_continuous(breaks = c(-1, -0.5, 0, 0.5, 1),
                       labels = c("-1", "", "0", "", "1")) +
    coord_cartesian(ylim = c(-1, 1)) + 
    guides(colour = FALSE, fill = FALSE) +
    theme_minimal() +
    theme(plot.title = element_text(size = 17, face = "bold"),
          axis.title = element_text(size = 17, face = "plain"),
          axis.text = element_text(size = 15),
          strip.text = element_text(size = 14, face = "italic"),
          strip.background = element_rect(fill = "lightgrey", colour = "white"),
          #axis.ticks.x = element_blank(),
          #axis.ticks.y = element_blank(),
          panel.grid.major = element_blank() )
  
  c <-
    ggplot(data =  average.pi.per.contrastGroup.time.course,
           aes_string(x = n,
                      y = "average.pi.total.feed.duration.s",
                      colour = "contrast.groups.noFoodType")) + 
    geom_ribbon(aes(ymin = ci.lower.average.pi.total.feed.duration.s, 
                    ymax = ci.upper.average.pi.total.feed.duration.s,
                    fill = contrast.groups.noFoodType),
                linetype = "dotted",
                alpha = 0.15) +
    geom_point(alpha = 0.5, size = 2.75) + 
    geom_path(alpha = 0.5, size = 1.2) +
    contrastColours + contrastFills +
    facet_wrap(~ contrast.groups.noFoodType) +
    geom_hline(yintercept = 0, linetype = "dotted", size = 0.8) +
    ylab("Preference Index Feed Duration") + xlab("Time (hours)") +
    ggtitle("   ") +
    scale_x_continuous(breaks = seq(from = 0, to = h * 3600, by = 3600),
                       labels = seq(from = 0, to = h * 3600, by = 3600) / 3600) +
    scale_y_continuous(breaks = c(-1, -0.5, 0, 0.5, 1),
                       labels = c("-1", "", "0", "", "1")) +
    coord_cartesian(ylim = c(-1, 1)) + 
    guides(colour = FALSE, fill = FALSE) +
    theme_minimal() +
    theme(plot.title = element_text(size = 17, face = "bold"),
          axis.title = element_text(size = 17, face = "plain"),
          axis.text = element_text(size = 15),
          strip.text = element_text(size = 14, face = "italic"),
          strip.background = element_rect(fill = "lightgrey", colour = "white"),
          #axis.ticks.x = element_blank(),
          #axis.ticks.y = element_blank(),
          panel.grid.major = element_blank() )
  
  fig.label <- data.frame(label = paste("Average Preference Indices for", reflevels[["FoodType"]][2] ,". 
The PI score is computed for each fly per time bin. These scores are then averaged for each contrast group. 
The 95% CI is shown as a surrounding envelope. A. PI by Feed Count. B. PI by Volume Intake. C. PI by Feed Duration"), 
x = 0, y = 0)
  
  bottom <- ggplot(fig.label,
                   aes(x, y, label = label)) +
    geom_text(size = 5, hjust = 0.5, vjust = 1) +
    coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
    theme(panel.grid.major = element_blank(), 
          panel.border = element_blank(), 
          axis.line = element_blank(), 
          axis.text.x = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks = element_blank(), 
          plot.margin = unit(c(-0.5,1, 0, 0.5), "lines") ) + 
    xlab(NULL) + ylab(NULL)
  
  ggdraw() + 
    draw_plot(a, x = 0, y = 0.7, width = 1, height = 0.3) +
    draw_plot(b, x = 0, y = 0.4, width = 1, height = 0.3) +
    draw_plot(c, x = 0, y = 0.1, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.05, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", " "), size = 25,
                    x = c(0, 0, 0, 0), y = c(1, 0.7, 0.4, 0))
} else {
  print("No PI Score to report; only 1 Food Choice in experiment.")
}

```

\newpage

## Binned Time Course Plots

```{r TimeCourse, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE, eval = TRUE, fig.height = 25, fig.width = 18, fig.fullwidth = TRUE}
n <- paste("bin.", as.character(bw/60), ".min", sep = "")
plot.properties <- list()
plot.properties[["Feed Count"]] <- c("mean.total.feed.count.per.fly",  # see bin.per.contrastGroup.noFood
                                     "ci.lower.mean.total.feed.count.per.fly", 
                                     "ci.upper.mean.total.feed.count.per.fly") # see hedges.g.withFood

plot.properties[["Cumulative Volume Intake (nl)"]] <- c("mean.cumulative.vol.intake.nanoliter",
                                                        "ci.lower.mean.cumulative.vol.intake.nanoliter", 
                                                        "ci.upper.mean.cumulative.vol.intake.nanoliter")

plot.properties[["Feed Size per Fly (nl)"]] <- c("mean.vol.per.feed.per.fly.nanoliter",
                                         "ci.lower.vol.per.feed.per.fly.nanoliter", 
                                         "ci.upper.vol.per.feed.per.fly.nanoliter")

plot.properties[["Feed Duration (s)"]] <- c("mean.feed.duration.s",
                                            "ci.lower.feed.duration.s", 
                                            "ci.upper.feed.duration.s")

plot.properties[["Feeding speed per Fly (nl/s)"]] <- c("mean.feeding.speed.per.fly.nl.per.s",
                                                       "ci.lower.feeding.speed.per.fly.nl.per.s", 
                                                       "ci.upper.feeding.speed.per.fly.nl.per.s")

for (m in names(plot.properties)) {
  ylim <- c(0, 1.1 * range(bin.per.contrastGroup.noFood[, plot.properties[[m]][3]], na.rm = TRUE)[2] )
  a <- ggplot(data = bin.per.contrastGroup.noFood, 
              aes_string(x = n, 
                         y = plot.properties[[m]][1],
                         colour = "contrast.groups.noFoodType",
                         group = "contrast.groups.noFoodType")) + 
    geom_ribbon(aes_string(ymin = plot.properties[[m]][2], 
                           ymax = plot.properties[[m]][3],
                           fill = "contrast.groups.noFoodType"),
                linetype = "dotted",
                alpha = 0.15) +
    geom_line() + 
    geom_point(size = 3.5, 
               shape = 18) +
    contrastColours + contrastFills +
    facet_wrap(~ contrast.groups.noFoodType, 
               ncol = 2,
               scales = "free_x") +
    scale_x_discrete(breaks = 3600 * (0:h),
                     labels = (0:h)) + 
    coord_cartesian(ylim = ylim) +
    guides(size = FALSE, alpha = FALSE, fill = FALSE) +
    ylab(m) + xlab("") +
    ggtitle(paste(m, "Time Course without Food Type", sep = " ") ) +
    theme_minimal() +
    theme(plot.title = element_text(size = 17, face = "plain"),
          axis.title = element_text(size = 17, face = "plain"),
          axis.text = element_text(size = 15),
          strip.text = element_text(size = 14, face = "italic"),
          strip.background = element_rect(fill = "lightgrey", colour = "white"),
          #axis.ticks.x = element_blank(),
          #axis.ticks.y = element_blank(),
          panel.grid.major = element_blank() ) +
    guides(colour = FALSE, fill = FALSE)
  
  if ("FoodType" %in% contrast.columns) {
    ylim <- c(0, 1.1 * range(bin.per.contrastGroup.withFood[, plot.properties[[m]][3]], na.rm = TRUE) [2] )
    b <- ggplot(data = bin.per.contrastGroup.withFood, 
                aes_string(x = n, 
                           y = plot.properties[[m]][1],
                           colour = "contrast.groups.noFoodType",
                           group = "contrast.groups.withFoodType")) + 
      geom_ribbon(aes_string(ymin = plot.properties[[m]][2], 
                             ymax = plot.properties[[m]][3],
                             fill = "contrast.groups.noFoodType"),
                  linetype = "dotted",
                  alpha = 0.15) +
      geom_line() + 
      geom_point(aes(shape = FoodType),
                 size = 3) +
      contrastColours + contrastFills +
      facet_wrap(~ contrast.groups.withFoodType, 
                 ncol = 2,
                 scales = "free_x") +
      scale_x_discrete(breaks = 3600 * (0:h),
                       labels = (0:h)) + 
      coord_cartesian(ylim = ylim) +
      guides(size = FALSE, alpha = FALSE, fill = FALSE) +
      xlab(paste("Time (hours)\n", "Bin Size = ", bw/60, " min", sep = "")) + 
      ylab(m) + ggtitle(paste(m, "Time Course with Food Type", sep = " ") ) +
      theme_minimal() +
      theme(plot.title = element_text(size = 17, face = "plain"),
            axis.title = element_text(size = 17, face = "plain"),
            axis.text = element_text(size = 15),
            strip.text = element_text(size = 14, face = "italic"),
            strip.background = element_rect(fill = "lightgrey", colour = "white"),
            #axis.ticks.x = element_blank(),
            #axis.ticks.y = element_blank(),
            panel.grid.major = element_blank() ) +
      guides(colour = FALSE, fill = FALSE, shape = FALSE)
    
    x <- grid.arrange(a, b, nrow = 2, 
                                   heights = c(1, 2) )
  } else {
    x <- a + xlab(paste("Time (hours)\n", "Bin Size = ", bw/60, " min", sep = ""))
  }
  
  fig.label <- data.frame(label = paste("Time Course for ", m, ". The dots indicate the average in that time bin. 
The 95-percent confidence interval of the metric is shown by a envelope around the line. Colours 
represent contrast groups, while the shape corresponds to the food choice. Diamonds are all food choices.", sep = ""), 
x = 0, y = 0)
  
  label <- ggplot(fig.label,
                  aes(x, y, label = label)) +
    geom_text(size = 5, hjust = 0.5, vjust = 1) +
    coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
    theme(panel.grid.major = element_blank(), 
          panel.border = element_blank(), 
          axis.line = element_blank(), 
          axis.text.x = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks = element_blank(), 
          plot.margin = unit(c(-0.5,1, 0, 0.5), "lines") ) + 
    xlab(NULL) + ylab(NULL)
  
  ggdraw() + 
    draw_plot(x, x = 0, y = 0.09, width = 1, height = 0.9) +
    draw_plot(label, x = 0, y = 0.015, width = 1, height = 0.1)
}

```

```{r KruskalDunnTestTableGeneration, message = FALSE, warning = FALSE, results = "hide", error = TRUE, echo = FALSE, eval = TRUE}
table.noFood <- list()
table.withFood <- list()

plot.properties <- list()
plot.properties[["Feed Count"]] <- c("total.feed.count",  # see summary.per.fly
                                     "average.total.feed.count.per.fly.g",
                                     "average.total.feed.count.per.fly.ci.lb", 
                                     "average.total.feed.count.per.fly.ci.ub") # see hedges.g.withFood

plot.properties[["Time To First Feed (s)"]] <- c("time.to.first.feed.s",  
                                                 "average.time.first.feed.per.fly.g",
                                                 "average.time.first.feed.per.fly.ci.lb", 
                                                 "average.time.first.feed.per.fly.ci.ub") 

plot.properties[["Total Volume Intake (nl)"]] <- c("total.vol.intake.nanoliter",  
                                                   "average.total.vol.intake.nanoliter.g",
                                                   "average.total.vol.intake.nanoliter.ci.lb", 
                                                   "average.total.vol.intake.nanoliter.ci.ub") 

plot.properties[["Feed Size per fly (nl)"]] <- c("mean.vol.per.feed.nanoliter",  
                                         "average.vol.per.feed.per.fly.nanoliter.g",
                                         "average.vol.per.feed.per.fly.nanoliter.ci.lb", 
                                         "average.vol.per.feed.per.fly.nanoliter.ci.ub") 

plot.properties[["Feed Duration (s)"]] <- c("mean.feed.duration.s", 
                                            "average.feed.duration.s.g",
                                            "average.feed.duration.s.ci.lb", 
                                            "average.feed.duration.s.ci.ub")

plot.properties[["Feeding Speed (nl/s)"]] <- c("mean.feeding.speed.nl.per.s", 
                                            "average.feeding.speed.per.fly.nl.per.s.g",
                                            "average.feeding.speed.per.fly.nl.per.s.ci.lb", 
                                            "average.feeding.speed.per.fly.nl.per.s.ci.ub")

# parameters for a nice-looking table.
tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                  x = 0.05)),
                     colhead = list(fg_params = list(hjust = 0, x = 0.05)) )

padding <- unit(0.5,"line")

for (m in names(plot.properties)) {
  if ( length( levels(summary.per.fly[, "contrast.groups.noFoodType"]) ) > 1 ) {
    
    # Kruskal-Wallis Test NO FOOD
    a <- kruskal.test(summary.per.fly[, plot.properties[[m]][1] ], 
                      summary.per.fly[, "contrast.groups.noFoodType"])
    kw.line.noFood <- paste( a$method, 
                             "\nchi-squared =", unname(signif(a$statistic, digits = 3)),
                             ", deg. of freedom =", unname(a$parameter),
                             "\np-value =", signif(a$p.value, 3) )
    kw.line.noFood = textGrob(kw.line.noFood,
                              gp = gpar(fontface = "italic", 
                                        fontsize = 12),
                              hjust = 0) 
    
    # Dunn's Test Table NO FOOD
    d <- dunn.test(summary.per.fly[, plot.properties[[m]][1] ], 
                   summary.per.fly[, "contrast.groups.noFoodType"], method = "bh")
    d <- data.frame(cbind(d$comparisons, signif(d$P.adjusted, digits = 3)))
    colnames(d) <- c("Comparison", "Adjusted\np-value")
    #d[, 1] <- gsub("\\n", "\\\t", d[, 1])
    d <- separate_(d, "Comparison", 
                   c("contrast.group.1", "contrast.group.2"),
                   sep = " - ")
    d[, "contrast.group.1"] <- factor(d[, "contrast.group.1"], levels = levels.contrast.groups.noFoodType)
    d[, "contrast.group.2"] <- factor(d[, "contrast.group.2"], levels = levels.contrast.groups.noFoodType)
    d[, "Adjusted\np-value"] <- as.numeric( as.character(d[, "Adjusted\np-value"]) )
    
    # Hedges' g table NO FOOD
    g <- hedges.g.noFood[ ,c("contrast.group.1", 
                             "contrast.group.2", 
                             "fixed.factor.level",
                             "contrast.factor.reference.level",
                             "contrast.factor.tested.level",
                             plot.properties[[m]][2],
                             plot.properties[[m]][3],
                             plot.properties[[m]][4]) ]
    for (c in c(3, 4, 5)) {
      g[, c] <- gsub("\\n", "\\\t", g[, c])
    }
    
    for (c in 1: nrow(g)) {
      g[c, 6] <- paste(g[c, 6], 
                       " [", g[c, 7], 
                       "; ", g[c, 8],
                       "]", sep = "")
    }
    g[, 8] <- NULL
    g[, 7] <- NULL
    
    # Join them together, part 1
    table.noFood[[m]] <- left_join(g, d, by = c("contrast.group.1", "contrast.group.2"))
    # Rearrange columns of dataframe d.
    d[, "to1"] <- d[, "contrast.group.2"]
    d[, "to2"] <- d[, "contrast.group.1"]
    d[, "contrast.group.2"] <- d[, "to2"]
    d[, "contrast.group.1"] <- d[, "to1"]
    d[, "to2"] <- NULL
    d[, "to1"] <- NULL
    # Join them together, part 2
    table.noFood[[m]] <- left_join(table.noFood[[m]], d, by = c("contrast.group.1", "contrast.group.2"))
    table.noFood[[m]] <- unite_(table.noFood[[m]], "Adjusted\np-value", 
                                c("Adjusted\np-value.x", "Adjusted\np-value.y"),
                                sep = "")
    # format the column properly
    table.noFood[[m]][, 7] <- gsub("\\NA", "\\", table.noFood[[m]][, 7])
    table.noFood[[m]][, 7] <- as.numeric( as.character(table.noFood[[m]][, 7]) )
    table.noFood[[m]][, "contrast.group.1"] <- NULL
    table.noFood[[m]][, "contrast.group.2"] <- NULL
    
    colnames(table.noFood[[m]]) <- c("Fixed factor\nlevel",
                                     "Contrast factor\nreference level",
                                     "Contrast factor\ntested level",
                                     "Hedges' g\n[95% CI]",
                                     "Post-hoc Dunn's Test\nAdjusted p-value")
    # Remove row numbers for pretty printing
    table.noFood[[m]] <- tableGrob(table.noFood[[m]], rows = rep(" ", nrow(table.noFood[[m]])), theme = tt)
    
    # Add results from Kruskal-Wallis test.
    table.noFood[[m]] <- gtable_add_rows(table.noFood[[m]], 
                                         heights = grobHeight(kw.line.noFood) + padding,
                                         pos = 0)
    
    table.noFood[[m]] <- gtable_add_grob(table.noFood[[m]], kw.line.noFood,
                                         t = 1, 
                                         l = 1, 
                                         r = ncol(table.noFood[[m]]))
    
    if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
      
      # Kruskal-Wallis Test WITH FOOD
      a <- kruskal.test(summary.per.fly[, plot.properties[[m]][1] ], 
                        summary.per.fly[, "contrast.groups.withFoodType"])
      kw.line.withFood <- paste( a$method, 
                                 "\nchi-squared =", unname(signif(a$statistic, digits = 3)),
                                 ", deg. of freedom =", unname(a$parameter),
                                 "\np-value =", signif(a$p.value, 3) )
      kw.line.withFood = textGrob(kw.line.withFood,
                                  gp = gpar(fontface = "italic", 
                                            fontsize = 12),
                                  hjust = 0) 
      
      # Dunn's Test Table WITH FOOD
      d <- dunn.test(summary.per.fly[, plot.properties[[m]][1] ], 
                     summary.per.fly[, "contrast.groups.withFoodType"], method = "bh")
      d <- data.frame(cbind(d$comparisons, signif(d$P.adjusted, digits = 3)))
      colnames(d) <- c("Comparison", "Adjusted\np-value")
      d <- separate_(d,  "Comparison", 
                     c("contrast.group.1", "contrast.group.2"),
                     sep = " - ")
      d[, "contrast.group.1"] <- factor(d[, "contrast.group.1"], levels = levels.contrast.groups.withFoodType)    
      d[, "contrast.group.2"] <- factor(d[, "contrast.group.2"], levels = levels.contrast.groups.withFoodType)    
      
      # Hedges' g table WITH FOOD
      g <- hedges.g.withFood[ ,c("contrast.group.1", 
                                 "contrast.group.2", 
                                 "fixed.factor.level",
                                 "contrast.factor.reference.level",
                                 "contrast.factor.tested.level",
                                 plot.properties[[m]][2],
                                 plot.properties[[m]][3],
                                 plot.properties[[m]][4]) ]
      
      
      for (c in 1: nrow(g)) {
        g[c, 6] <- paste(g[c, 6], 
                         " [", g[c, 7], 
                         "; ", g[c, 8],
                         "]", sep = "")
      }
      g[, 8] <- NULL
      g[, 7] <- NULL
      
      # Join them together, part 1
      table.withFood[[m]] <- left_join(g, d, by = c("contrast.group.1", "contrast.group.2"))
      # Rearrange columns of dataframe d.
      d[, "to1"] <- d[, "contrast.group.2"]
      d[, "to2"] <- d[, "contrast.group.1"]
      d[, "contrast.group.2"] <- d[, "to2"]
      d[, "contrast.group.1"] <- d[, "to1"]
      d[, "to2"] <- NULL
      d[, "to1"] <- NULL
      # Join them together, part 2
      table.withFood[[m]] <- left_join(table.withFood[[m]], d, by = c("contrast.group.1", "contrast.group.2"))
      table.withFood[[m]] <- unite_(table.withFood[[m]], "Adjusted\np-value", 
                                    c("Adjusted\np-value.x", "Adjusted\np-value.y"),
                                    sep = "")
      # format the column properly
      table.withFood[[m]][, 7] <- gsub("\\NA", "\\", table.withFood[[m]][, 7])
      table.withFood[[m]][, 7] <- as.numeric( as.character(table.withFood[[m]][, 7]) )
      table.withFood[[m]][, "contrast.group.1"] <- NULL
      table.withFood[[m]][, "contrast.group.2"] <- NULL
      
      colnames(table.withFood[[m]]) <- c("Fixed factor\nlevel",
                                         "Contrast factor\nreference level",
                                         "Contrast factor\ntested level",
                                         "Hedges' g\n[95% CI]",
                                         "Post-hoc Dunn's Test\nAdjusted p-value")
      
      # Remove row numbers for pretty printing
      table.withFood[[m]] <- tableGrob(table.withFood[[m]], rows = rep(" ", nrow(table.withFood[[m]])), theme = tt)
      
      # Add results from Kruskal-Wallis test.
      table.withFood[[m]] <- gtable_add_rows(table.withFood[[m]], 
                                             heights = grobHeight(kw.line.withFood) + padding,
                                             pos = 0)
      
      table.withFood[[m]] <- gtable_add_grob(table.withFood[[m]], kw.line.withFood,
                                             t = 1, 
                                             l = 1, 
                                             r = ncol(table.withFood[[m]]))
    }
  }
}
```

\newpage

## Feed Count Summary

```{r DensityDistributionFeedCount, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Total Feed Counts per Fly. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = total.feed.count)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.total.feed.count.per.fly), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.total.feed.count.per.fly), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Total Feed Counts Per Fly") +
  ggtitle("Density Distribution of Total Feed Counts\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + 
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("mean = ", mean.total.feed.count.per.fly, sep = ""),
                x = mean.total.feed.count.per.fly, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2]), 
            colour = "orange",
            hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.total.feed.count.per.fly, sep = ""),
                x = median.total.feed.count.per.fly, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = total.feed.count)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.total.feed.count.per.fly), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.total.feed.count.per.fly), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Total Feed Counts Per Fly") +
    ggtitle("Density Distribution of Total Feed Counts\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.total.feed.count.per.fly, sep = ""),
                                      x = mean.total.feed.count.per.fly,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.total.feed.count.per.fly, sep = ""),
                  x = median.total.feed.count.per.fly, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r feedCountSummaryPlot_and_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE, fig.cap = ""}
a <- "total.feed.count" # from summary.per.fly
b <- "mean.total.feed.count.per.fly" # from summary.per.contrastGroup.withFood
c <- "ci.lower.mean.total.feed.count.per.fly"
d <- "ci.upper.mean.total.feed.count.per.fly"
ylab <- "Total Feed Count"
plot.title <- "Total Feed Count Summary Plot"
bin.width <- 1
dot.size <- 1.2

ylim <- c(0, round(1.1 * range(summary.per.fly[, a])[2]))

# Reverse levels because the contrast groups go on the y-axis.
temp.summary.per.contrastGroup.withFood <- summary.per.contrastGroup.withFood
temp.summary.per.contrastGroup.withFood[, "contrast.groups.withFoodType"] <- 
  factor(temp.summary.per.contrastGroup.withFood[, "contrast.groups.withFoodType"], 
         levels = rev(levels(temp.summary.per.contrastGroup.withFood[, "contrast.groups.withFoodType"])) )

temp.summary.per.contrastGroup.noFood <- summary.per.contrastGroup.noFood
temp.summary.per.contrastGroup.noFood[, "contrast.groups.noFoodType"] <- 
  factor(temp.summary.per.contrastGroup.noFood[, "contrast.groups.noFoodType"], 
         levels = rev(levels(temp.summary.per.contrastGroup.noFood[, "contrast.groups.noFoodType"])) )

#### Figure Label
fig.label <- data.frame(label = "Feed Count Summary Plot. Each scatterpoint is the total feed count for a fly across the assay duration. The vertical crossbar 
indicates the average total feed count per fly for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 20),
                       labels = seq(from = 0, to = ylim[2], by = 20),
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, "total.fly.count", "feeding.fly.count", 
                                                    "sum.feed.count", "mean.total.feed.count.per.fly", 
                                                    "median.total.feed.count.per.fly", "sd.total.feed.count.per.fly", 
                                                    "ci.lower.mean.total.feed.count.per.fly", "ci.upper.mean.total.feed.count.per.fly")]
  # for (c in contrast.columns) {
  #   temp.df[, c] <- factor(temp.df[, c], reflevels[[c]])
  #   temp.df <- arrange_(temp.df, c) # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
  # }
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, "Total\nfly count", "Feeding\nfly count", 
                         "Total\nfeed count", 
                         "Average\ntotal feed count\nper fly [95% CI]", 
                         "Median", "sd", "low", "high")
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                                   " [", temp.df[x, "low"], 
                                                                   "; ", temp.df[x, "high"],
                                                                   "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 20),
                       labels = seq(from = 0, to = ylim[2], by = 20),
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, "total.fly.count", "feeding.fly.count", 
                                                    "sum.feed.count", "mean.total.feed.count.per.fly", 
                                                    "median.total.feed.count.per.fly", "sd.total.feed.count.per.fly", 
                                                    "ci.lower.mean.total.feed.count.per.fly", "ci.upper.mean.total.feed.count.per.fly")]
  # for (c in contrast.columns) {
  #   temp.df[, c] <- factor(temp.df[, c], reflevels[[c]])
  #   temp.df <- arrange_(temp.df, c) # VERY IMPORTANT -- ORDERS THE DATAFRAME AS DESIRED.
  # }
  
  colnames(temp.df) <- c(contrast.columns, "Total\nfly count", "Feeding\nfly count", 
                         "Total\nfeed count\nof group", 
                         "Average\ntotal feed count\nper fly [95% CI]", 
                         "Median", "sd", "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
 
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}
```

```{r feedCountKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, results = "hide", error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25, fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Feed Count Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Feed Count"]], table.withFood[["Feed Count"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Total Feed Count per Fly\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Feed Count"]],
                 top = textGrob("Average Total Feed Count per Fly\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

\newpage

## Total Volume Intake Summary

```{r DensityDistributionTotalVolumeIntake, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Total Volume Intake. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = total.vol.intake.nanoliter)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.total.vol.intake.nanoliter), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.total.vol.intake.nanoliter), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Total Volume Intake (nl)") +
  ggtitle("Density Distribution of Total Volume Intake\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + geom_text(data = summary.per.contrastGroup.withFood,
                                aes(label = paste("mean = ", mean.total.vol.intake.nanoliter, sep = ""),
                                    x = mean.total.vol.intake.nanoliter, # + (0.05 * xrange[2] - xrange[1]),
                                    y = yrange1[2]), 
                                colour = "orange",
                                hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.total.vol.intake.nanoliter, sep = ""),
                x = median.total.vol.intake.nanoliter, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = total.vol.intake.nanoliter)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
    facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.total.vol.intake.nanoliter), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.total.vol.intake.nanoliter), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Total Volume Intake (nl)") +
    ggtitle("Density Distribution of Total Volume Intake\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.total.vol.intake.nanoliter, sep = ""),
                                      x = mean.total.vol.intake.nanoliter,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.total.vol.intake.nanoliter, sep = ""),
                  x = median.total.vol.intake.nanoliter, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r VolumeIntakeSummaryPlot_And_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE}
a <- "total.vol.intake.nanoliter" # from summary.per.fly
b <- "mean.total.vol.intake.nanoliter" # from summary.per.contrastGroup.withFood
c <- "ci.lower.mean.total.vol.intake.nanoliter"
d <- "ci.upper.mean.total.vol.intake.nanoliter"
ylab <- "Total Volume Intake (nl)"
plot.title <- "Total Volume Intake Summary Plot"
bin.width <- 1
dot.size <- 2

ylim <- c(0, round(1.1 * range(summary.per.fly[, a])[2]))

#### Figure Label
fig.label <- data.frame(label = "Total Volume Intake Summary Plot. Each scatterpoint is the total volume intake for a fly across the assay duration. The vertical crossbar 
indicates the average total volume intake for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 20),
                       labels = seq(from = 0, to = ylim[2], by = 20),
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, "total.fly.count", "feeding.fly.count", 
                                                    "grand.total.vol.intake.nanoliter", "mean.total.vol.intake.nanoliter", 
                                                    "median.total.vol.intake.nanoliter", "sd.mean.total.vol.intake.nanoliter", 
                                                    "ci.lower.mean.total.vol.intake.nanoliter","ci.upper.mean.total.vol.intake.nanoliter")]
  
  #temp.df <- arrange_(temp.df, contrast.columns)
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, "Total\nfly count", "Feeding\nfly count", 
                         "Grand total\nVol. intake\n(nl)", 
                         "Mean total\nVol. intake (nl)\n[95% CI]", 
                         "Median (nl)", "sd (nl)", 
                         "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 20),
                       labels = seq(from = 0, to = ylim[2], by = 20),
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, "total.fly.count", "feeding.fly.count", 
                                                    "grand.total.vol.intake.nanoliter", "mean.total.vol.intake.nanoliter", 
                                                    "median.total.vol.intake.nanoliter", "sd.mean.total.vol.intake.nanoliter", 
                                                    "ci.lower.mean.total.vol.intake.nanoliter","ci.upper.mean.total.vol.intake.nanoliter")]
  
  #temp.df <- arrange_(temp.df, contrast.columns)
  
  colnames(temp.df) <- c(contrast.columns, "Total\nfly count", "Feeding\nfly count", 
                         "Grand total\nVol. intake\n(nl)", 
                         "Mean total\nVol. intake (nl)\n[95% CI]", 
                         "Median (nl)", "sd (nl)", 
                         "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}

```

```{r VolumeIntakeKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25,  fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Average Total Volume Intake Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Total Volume Intake (nl)"]], table.withFood[["Total Volume Intake (nl)"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Total Volume Intake\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Time To First Feed (s)"]],
                 top = textGrob("Average Total Volume Intake\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

\newpage

## Time to First Feed Summary

```{r DensityDistributionTimeToFirstFeed, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Time to First Feed. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = time.to.first.feed.s)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.time.to.first.feed.s), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.time.to.first.feed.s), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Time to First Feed (s)") +
  ggtitle("Density Distribution of Time to First Feed\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + geom_text(data = summary.per.contrastGroup.withFood,
                                aes(label = paste("mean = ", mean.time.to.first.feed.s, sep = ""),
                                    x = mean.time.to.first.feed.s, # + (0.05 * xrange[2] - xrange[1]),
                                    y = yrange1[2]), 
                                colour = "orange",
                                hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.time.to.first.feed.s, sep = ""),
                x = median.time.to.first.feed.s, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = time.to.first.feed.s)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.time.to.first.feed.s), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.time.to.first.feed.s), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Time to First Feed (s)") +
    ggtitle("Density Distribution of Time to First Feed\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.time.to.first.feed.s, sep = ""),
                                      x = mean.time.to.first.feed.s,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.time.to.first.feed.s, sep = ""),
                  x = median.time.to.first.feed.s, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r TimeToFirstFeedSummaryPlot_and_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE}
a <- "time.to.first.feed.s" # from summary.per.fly
b <- "mean.time.to.first.feed.s" # from summary.per.contrastGroup.withFood
c <- "ci.lower.time.to.first.feed.s"
d <- "ci.upper.time.to.first.feed.s"
ylab <- "Time to First Feed (hours)"
plot.title <- "Average Time to First Feed Summary Plot"
bin.width <- 300
dot.size <- 0.6
ylim <- c(0, h * 3600)

#### Figure Label
fig.label <- data.frame(label = "Time to First Feed Summary Plot. Each scatterpoint is the average time to first feed for a fly. The vertical crossbar 
indicates the average time to first feed for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3600),
                       labels = seq(from = 0, to = ylim[2], by = 3600) / 3600,
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, "total.fly.count", "feeding.fly.count", 
                                                    "mean.time.to.first.feed.s", 
                                                    "median.time.to.first.feed.s", "sd.time.to.first.feed.s", 
                                                    "ci.lower.time.to.first.feed.s","ci.upper.time.to.first.feed.s")]
  
  for (x in (length(contrast.columns.noFoodType) + 3): ncol(temp.df)) {
    temp.df[, x] <- round(temp.df[, x]/60, digits = 2)
  }  
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean\ntime to\nfirst feed (min) [95% CI]", 
                         "median\ntime to\nfirst feed (min)", "sd time to\nfirst feed (min)", 
                         "low", "high")
  

  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3600),
                       labels = seq(from = 0, to = ylim[2], by = 3600) / 3600,
                       expand = c(0.01, 0)) + # multiplicative expansion factor so zero feeds show up nicely
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, "total.fly.count", "feeding.fly.count", 
                                                    "mean.time.to.first.feed.s", 
                                                    "median.time.to.first.feed.s", "sd.time.to.first.feed.s", 
                                                    "ci.lower.time.to.first.feed.s","ci.upper.time.to.first.feed.s")]
  
  for (x in (length(contrast.columns) + 3): ncol(temp.df)) {
    temp.df[, x] <- round(temp.df[, x]/60, digits = 2)
  }    
  
  colnames(temp.df) <- c(contrast.columns, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean\ntime to\nfirst feed (min) [95% CI]", 
                         "median\ntime to\nfirst feed (min)", "sd time to\nfirst feed (min)", 
                         "low", "high")
  
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}

```

```{r TimeToFirstFeedKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25,  fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Time to First Feed Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Time To First Feed (s)"]], table.withFood[["Time To First Feed (s)"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Time to First Feed\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Time To First Feed (s)"]],
                 top = textGrob("Average Time to First Feed\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

\newpage

## Feed Size (aka Meal Size) per Fly Summary

```{r DensityDistributionFeedSizePerFly, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Feed Size Per Fly. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = mean.vol.per.feed.nanoliter)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.vol.per.feed.nanoliter), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.vol.per.feed.nanoliter), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Feed Size (nl)") +
  ggtitle("Density Distribution of Feed Size PER FLY\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + geom_text(data = summary.per.contrastGroup.withFood,
                                aes(label = paste("mean = ", mean.vol.per.feed.nanoliter, sep = ""),
                                    x = mean.vol.per.feed.nanoliter, # + (0.05 * xrange[2] - xrange[1]),
                                    y = yrange1[2]), 
                                colour = "orange",
                                hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.vol.per.feed.nanoliter, sep = ""),
                x = median.vol.per.feed.nanoliter, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = mean.vol.per.feed.nanoliter)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.vol.per.feed.nanoliter), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.vol.per.feed.nanoliter), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Feed Size (nl)") +
    ggtitle("Density Distribution of Feed Size PER FLY\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.vol.per.feed.nanoliter, sep = ""),
                                      x = mean.vol.per.feed.nanoliter,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.vol.per.feed.nanoliter, sep = ""),
                  x = median.vol.per.feed.nanoliter, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r FeedSizePerFlySummaryPlot_And_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE}
a <- "mean.vol.per.feed.nanoliter" # from summary.per.fly
b <- "mean.vol.per.feed.per.fly.nanoliter" # from summary.per.contrastGroup.withFood
c <- "ci.lower.vol.per.feed.per.fly.nanoliter"
d <- "ci.upper.vol.per.feed.per.fly.nanoliter"
ylab <- "Average Feed Size per Fly (nl)"
plot.title <- "Average Feed Size per Fly\nSummary Plot"
bin.width <- 0.25
dot.size <- 1

ylim <- c(0, 1.1 * range(summary.per.fly[, "mean.vol.per.feed.nanoliter"], na.rm = TRUE)[2])

#### Figure Label
fig.label <- data.frame(label = "Average Feed Size Per Fly Summary Plot. Each scatterpoint is the average feed size for a single fly. The vertical crossbar 
indicates the average feed size per feeding fly for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3),
                       labels = seq(from = 0, to = ylim[2], by = 3),
                       expand = c(0.05, 0)) + # Not sure why I have to tweak the axis expansion constant manually for this plot.
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, "total.fly.count", "feeding.fly.count", 
                                                    "mean.vol.per.feed.per.fly.nanoliter", 
                                                    "median.vol.per.feed.per.fly.nanoliter", "sd.vol.per.feed.per.fly.nanoliter", 
                                                    "ci.lower.vol.per.feed.per.fly.nanoliter","ci.upper.vol.per.feed.per.fly.nanoliter")]
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean \nfeed size\nper feeding fly (nl)", 
                         "median (nl)", "sd (nl) ", 
                         "low", "high")
  
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3),
                       labels = seq(from = 0, to = ylim[2], by = 3),
                       expand = c(0.05, 0)) + 
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, "total.fly.count", "feeding.fly.count", 
                                                    "mean.vol.per.feed.per.fly.nanoliter", 
                                                    "median.vol.per.feed.per.fly.nanoliter", "sd.vol.per.feed.per.fly.nanoliter", 
                                                    "ci.lower.vol.per.feed.per.fly.nanoliter","ci.upper.vol.per.feed.per.fly.nanoliter")]
  
  colnames(temp.df) <- c(contrast.columns, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean \nfeed size\nper feeding fly (nl)", 
                         "median (nl)", "sd (nl) ", 
                         "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}

```

```{r FeedSizeKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25,  fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Feed Size Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Feed Size per fly (nl)"]], table.withFood[["Feed Size per fly (nl)"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Feed Size\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Feed Size per fly (nl)"]],
                 top = textGrob("Average Feed Size\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

\newpage

## Feed Duration Summary

```{r DensityDistributionFeedDuration, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Feed Duration. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = mean.feed.duration.s)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.feed.duration.s), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.feed.duration.s), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Feed Duration (ms)") +
  ggtitle("Density Distribution of Feed Duration\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + geom_text(data = summary.per.contrastGroup.withFood,
                                aes(label = paste("mean = ", mean.feed.duration.s, sep = ""),
                                    x = mean.feed.duration.s, # + (0.05 * xrange[2] - xrange[1]),
                                    y = yrange1[2]), 
                                colour = "orange",
                                hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.feed.duration.s, sep = ""),
                x = median.feed.duration.s, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = mean.feed.duration.s)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.feed.duration.s), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.feed.duration.s), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Feed Duration (nl)") +
    ggtitle("Density Distribution of Feed Duration\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.feed.duration.s, sep = ""),
                                      x = mean.feed.duration.s,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.feed.duration.s, sep = ""),
                  x = median.feed.duration.s, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r feedDurationSummaryPlot_And_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE}
#### Make line-range plot
a <- "mean.feed.duration.s" # from summary.per.fly
b <- "mean.feed.duration.s" # from summary.per.contrastGroup.withFood
c <- "ci.lower.feed.duration.s"
d <- "ci.upper.feed.duration.s"
ylab <- "Average Feed Duration per Fly (s)"
plot.title <- "Average Feed Duration per Fly Summary Plot"
bin.width <- 0.2
dot.size <- 0.8

ylim <- ceiling(c(0, (1.1 * range(summary.per.fly[, "mean.feed.duration.s"], na.rm = TRUE))[2]))

#### Figure Label
fig.label <- data.frame(label = "Average Feed Duration Per Fly Summary Plot. Each scatterpoint is the average feed duration for a single fly. The vertical crossbar 
indicates the average feed size per feeding fly for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3),
                       labels = seq(from = 0, to = ylim[2], by = 3),
                       expand = c(0.1, 0.75)) + # Not sure why I have to tweak the axis expansion constant manually for this plot.
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, 
                                                    "total.fly.count", "feeding.fly.count", 
                                                    "mean.feed.duration.s", "median.feed.duration.s",
                                                    "sd.feed.duration.s",
                                                    "ci.lower.feed.duration.s","ci.upper.feed.duration.s")]
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean \nfeed duration\n (s)", "median (s)",
                         "sd (s)", "low", "high")
  
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(breaks = seq(from = 0, to = ylim[2], by = 3),
                       labels = seq(from = 0, to = ylim[2], by = 3),
                       expand = c(0.1, 0.75)) + # Not sure why I have to tweak the axis expansion constant manually for this plot.
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, 
                                                    "total.fly.count", "feeding.fly.count", 
                                                    "mean.feed.duration.s", "median.feed.duration.s",
                                                    "sd.feed.duration.s",
                                                    "ci.lower.feed.duration.s","ci.upper.feed.duration.s")]
  
  colnames(temp.df) <- c(contrast.columns, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean \nfeed duration\n (s)", "median (s)",
                         "sd (s)", "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 4)] <- paste(temp.df[x, (length(contrast.columns) + 4)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}

```

```{r feedDurationKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25, fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Feed Duration Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Feed Duration (s)"]], table.withFood[["Feed Duration (s)"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Feed Duration\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Feed Duration (s)"]],
                 top = textGrob("Average Feed Duration\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

\newpage

## Feeding Speed Summary

```{r DensityDistributionFeedingSpeed, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 16, fig.width = 10, fig.fullwidth = FALSE, fig.cap = "Density Distribution of Feeding Speed. The orange line indicates the mean of the distribution, while the purple line indicates the median."}
plot.list <- list()

a <- ggplot(data = summary.per.fly, 
            aes(x = mean.feeding.speed.nl.per.s)) +
  geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
  geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.withFoodType, scales = "free_y") +
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = mean.feeding.speed.nl.per.s), 
             colour = "orange") + 
  geom_vline(data = summary.per.contrastGroup.withFood, 
             aes(xintercept = median.feeding.speed.nl.per.s), 
             colour = "purple") + 
  theme(axis.line.y = element_blank(), 
        axis.line.x = element_blank()) +
  xlab("Feeding Speed (nl/s)") +
  ggtitle("Density Distribution of Feeding Speed\nWith Food Type") +
  theme(strip.text.x = element_text(size = 14),
        plot.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16))

# See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
xrange1 <- ggplot_build(a)$panel$ranges[[2]]$x.range
yrange1 <- ggplot_build(a)$panel$ranges[[2]]$y.range

plot.list[[1]] <- a + geom_text(data = summary.per.contrastGroup.withFood,
                                aes(label = paste("mean = ", mean.feeding.speed.nl.per.s, sep = ""),
                                    x = mean.feeding.speed.nl.per.s, # + (0.05 * xrange[2] - xrange[1]),
                                    y = yrange1[2]), 
                                colour = "orange",
                                hjust = -0.1) +
  geom_text(data = summary.per.contrastGroup.withFood,
            aes(label = paste("median = ", median.feeding.speed.nl.per.s, sep = ""),
                x = median.feeding.speed.nl.per.s, # + (0.05 * xrange[2] - xrange[1]),
                y = yrange1[2] * 0.75), 
            colour = "purple",
            hjust = -0.1) + 
  guides(colour = FALSE)

if ("FoodType" %in% contrast.columns) {
  
  a <- ggplot(data = summary.per.fly, 
              aes(x = mean.feeding.speed.nl.per.s)) +
    geom_rug(alpha = 0.3) + # geom_histogram(binwidth = 1) +
    geom_density(adjust = 2, alpha = 0.5, linetype = "dotted", fill = "lightgrey") + 
  facet_wrap(~ contrast.groups.noFoodType, scales = "free_y") +
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = mean.feeding.speed.nl.per.s), 
               colour = "orange") + 
    geom_vline(data = summary.per.contrastGroup.noFood, 
               aes(xintercept = median.feeding.speed.nl.per.s), 
               colour = "purple") + 
    theme(axis.line.y = element_blank(), 
          axis.line.x = element_blank()) +
    xlab("Feeding Speed (nl/s)") +
    ggtitle("Density Distribution of Feeding Speed\nWithout Food Type") +
    theme(strip.text.x = element_text(size = 14),
          plot.title = element_text(size = 18),
          axis.title = element_text(size = 18),
          axis.text = element_text(size = 16))
  
  # See http://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object for extracting limits!
  xrange <- ggplot_build(a)$panel$ranges[[2]]$x.range
  yrange <- ggplot_build(a)$panel$ranges[[2]]$y.range
  
  plot.list[[2]] <- a + geom_text(data = summary.per.contrastGroup.noFood,
                                  aes(label = paste("mean = ", mean.feeding.speed.nl.per.s, sep = ""),
                                      x = mean.feeding.speed.nl.per.s,
                                      y = yrange[2]), 
                                  colour = "orange",
                                  hjust = -0.1) +
    geom_text(data = summary.per.contrastGroup.noFood,
              aes(label = paste("median = ", median.feeding.speed.nl.per.s, sep = ""),
                  x = median.feeding.speed.nl.per.s, 
                  y = yrange[2] * 0.75), 
              colour = "purple",
              hjust = -0.1) + 
    guides(colour = FALSE)
}

if (length(plot.list) == 1) {
  plot.list[[1]]
} else {
  plot_grid(plotlist = plot.list, ncol = 1, nrow = 2)
}
```

```{r feedingSpeedSummaryPlot_And_Table, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 18, fig.width = 15, fig.fullwidth = TRUE}
#### Make Summary Table
a <- "mean.feeding.speed.nl.per.s" # from summary.per.fly
b <- "mean.feeding.speed.nl.per.s" # from summary.per.contrastGroup.withFood
c <- "ci.lower.feeding.speed.nl.per.s"
d <- "ci.upper.feeding.speed.nl.per.s"
ylab <- "Feeding Speed (nl/s)"
plot.title <- "Average Feeding Speed Summary Plot"
bin.width <- 0.01
dot.size <- 2.5

ylim <- c(0, 1.1 * range(summary.per.fly[, "mean.feeding.speed.nl.per.s"], na.rm = TRUE)[2])

#### Figure Label
fig.label <- data.frame(label = "Average Feeding Speed Summary Plot. Each scatterpoint is the average feeding speed for a single feeding fly. The vertical crossbar 
indicates the average feeding speed per feeding fly for that contrast group; the horizontal crossbar indicates the 95% confidence interval.", 
                        x = 0, y = 0)

bottom <- ggplot(fig.label,
                 aes(x, y, label = label)) +
  geom_text(size = 5, hjust = 0.5, vjust = 1) +
  coord_cartesian(xlim = c(-0.1, 0.1), ylim = c(-0.1, 0.1)) +
  theme(panel.grid.major = element_blank(), 
        panel.border = element_blank(), 
        axis.line = element_blank(), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(), 
        plot.margin = unit(c(0, 0, 0, 0), "lines") ) + 
  xlab(NULL) + ylab(NULL)

#### Make line-range plot No Food
  summ.plot.noFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.noFood, 
                    aes_string(x = "contrast.groups.noFoodType", 
                               y = b,
                               colour = "contrast.groups.noFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.noFoodType", 
                            y = a,
                            shape = "FoodType",
                            fill = "contrast.groups.noFoodType"
                 ),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(
#       breaks = seq(from = 0, to = ylim[2], by = 3),
#       labels = seq(from = 0, to = ylim[2], by = 3),
      expand = c(0.07, 0)) + 
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table No Food
  summary.per.contrastGroup.noFood <- arrange(summary.per.contrastGroup.noFood, contrast.groups.noFoodType)
  
  temp.df <- summary.per.contrastGroup.noFood[, c(contrast.columns.noFoodType, 
                                                    "total.fly.count", "feeding.fly.count", 
                                                    "mean.feeding.speed.per.fly.nl.per.s", 
                                                    "median.feeding.speed.per.fly.nl.per.s",
                                                    "sd.feeding.speed.nl.per.s",
                                                    "ci.lower.feeding.speed.nl.per.s",
                                                    "ci.upper.feeding.speed.nl.per.s")]
  
  colnames(temp.df) <- c(contrast.columns.noFoodType, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean\nfeeding speed\n (nl/s)", "median",
                         "sd", "low", "high")
  
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns.noFoodType) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.noFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {
  
  #### Make Summary Plot With Food
  summ.plot.withFood <- ggplot() + 
    geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                    aes_string(x = "contrast.groups.withFoodType", 
                               y = b,
                               colour = "contrast.groups.withFoodType",
                               ymin = c,
                               ymax = d),
                    size = 4,
                    shape = "|",
                    alpha = 0.75) +
    geom_dotplot(data = summary.per.fly, 
                 aes_string(x = "contrast.groups.withFoodType", 
                            y = a,
                            fill = "contrast.groups.withFoodType",
                            shape = "FoodType"),
                 binaxis = "y", 
                 alpha = 0.25,
                 method = "histodot",
                 binwidth = bin.width, # Change the size of the dot by changing the size of the bin.
                 stackdir = "center",
                 stackratio = 1, 
                 dotsize = dot.size) + 
    contrastColours + contrastFills +
    guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(
      #       breaks = seq(from = 0, to = ylim[2], by = 3),
      #       labels = seq(from = 0, to = ylim[2], by = 3),
      expand = c(0.07, 0)) + 
    ylab(ylab) + xlab("") + 
    theme_minimal() + #ggtitle(plot.title) +
    theme( axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 16, face = "plain"),
           axis.ticks.y = element_blank(),
           panel.grid.major.y = element_blank(),
           panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
    coord_flip()
  
  #### Make Summary Table With Food
  summary.per.contrastGroup.withFood <- arrange(summary.per.contrastGroup.withFood, contrast.groups.withFoodType)
  
  temp.df <- summary.per.contrastGroup.withFood[, c(contrast.columns, 
                                                    "total.fly.count", "feeding.fly.count", 
                                                    "mean.feeding.speed.per.fly.nl.per.s", 
                                                    "median.feeding.speed.per.fly.nl.per.s",
                                                    "sd.feeding.speed.nl.per.s",
                                                    "ci.lower.feeding.speed.nl.per.s",
                                                    "ci.upper.feeding.speed.nl.per.s")]
  
  colnames(temp.df) <- c(contrast.columns, 
                         "total\nfly count", "feeding\nfly count", 
                         "mean\nfeeding speed\n (nl/s)", "median",
                         "sd", "low", "high")
  
  for (x in 1: nrow(temp.df)) {
    temp.df[x, (length(contrast.columns) + 3)] <- paste(temp.df[x, (length(contrast.columns) + 3)], 
                                                        " [", temp.df[x, "low"], 
                                                        "; ", temp.df[x, "high"],
                                                        "]", sep = "")
  }
  temp.df[, "low"] <- NULL
  temp.df[, "high"] <- NULL
  
  tt <- ttheme_default(core = list(fg_params = list(hjust = 0, 
                                                    x = 0.05)),
                       colhead = list(fg_params = list(hjust = 0, x = 0.05))
  )
  
  summ.table.withFood <- tableGrob( temp.df, rows = rep(" ", nrow(temp.df)), theme = tt )
  
  
  ggdraw() + 
    draw_plot(summ.plot.withFood, x = 0, y = 0.6, width = 1, height = 0.4) +
    draw_plot(summ.table.withFood, x = 0, y = 0.4, width = 1, height = 0.2) +
    draw_plot(summ.plot.noFood, x = 0, y = 0.19, width = 1, height = 0.2) +
    draw_plot(summ.table.noFood, x = 0, y = 0.03, width = 1, height = 0.2) +
    draw_plot(bottom, x = 0, y = 0.01, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", "C", "D"," "), size = 25,
                    x = c(0, 0, 0, 0, 0), 
                    y = c(0.99, 0.61, 0.4, 0.2, 0))
  
} else {
  ggdraw() + 
    draw_plot(summ.plot.noFood, x = 0, y = 0.45, width = 1, height = 0.5) +
    draw_plot(summ.table.noFood, x = 0, y = 0.15, width = 1, height = 0.3) +
    draw_plot(bottom, x = 0, y = 0.09, width = 1, height = 0.1) +
    draw_plot_label(label = c("A", "B", " "), size = 25,
                    x = c(0, 0, 0), y = c(0.99, 0.45, 0))
}

```

```{r feedingSpeedKruskalDunnTestHedgesG, message = FALSE, warning = FALSE, error = TRUE, echo = FALSE, eval = TRUE, fig.height = 25,  fig.width = 20, fig.fullwidth = TRUE, fig.cap = "Feeding Speed Pairwise post-hoc Dunn's Test with Benjamini-Hochberg adjusted p-values, and Effect Sizes"}
if ( length(levels(rawdata.all[, "FoodIdx"])) > 1 ) {

    grid.arrange(table.noFood[["Feeding Speed (nl/s)"]], table.withFood[["Feeding Speed (nl/s)"]], 
                 nrow = 2, heights = c(0.5, 1.5),
                 top = textGrob("Average Feeding Speed\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) ) 
  } else if ( length(levels(rawdata.all[, "FoodIdx"])) == 1 ) {
    grid.arrange(table.noFood[["Feeding Speed (nl/s)"]],
                 top = textGrob("Average Feeding Speed\nPairwise Comparisons",
                                gp = gpar(fontface = "bold", 
                                          fontsize = 20),
                                vjust = 1) )
  } else if ( length(levels(summary.per.fly[, "contrast.groups.noFoodType"])) == 1 )  {
  print("No experimental contrasts; no Kruskal-Wallis ANOVA can be performed.")
}
```

```{r Comparison, message = FALSE, warning = FALSE, error = FALSE, echo = FALSE, eval = FALSE, fig.height = 20, fig.width = 18, fig.fullwidth = FALSE}
plot.properties <- list()
plot.properties[["Feed Count"]] <- c("total.feed.count", "mean.total.feed.count.per.fly", # see summary.per.fly, summary.per.contrastGroup.withFoodType
                                     "ci.lower.mean.total.feed.count.per.fly", "ci.upper.mean.total.feed.count.per.fly", # see summary.per.contrastGroup.withFoodType
                                     "average.total.feed.count.per.fly.ci.lb", "average.total.feed.count.per.fly.ci.ub", # see hedges.g.withFood
                                     "average.total.feed.count.per.fly.g", 1, 1.2) # see hedges.g.withFood, binwidth, dotsize.

plot.properties[["Time To First Feed (min)"]] <- c("time.to.first.feed.s", "mean.time.to.first.feed.s",
                                             "ci.lower.time.to.first.feed.s", "ci.upper.time.to.first.feed.s",
                                             "average.time.first.feed.per.fly.ci.lb", "average.time.first.feed.per.fly.ci.ub",
                                             "average.time.first.feed.per.fly.g", 300, 0.6)

plot.properties[["Total Volume Intake (nl)"]] <- c("total.vol.intake.nanoliter", "mean.total.vol.intake.nanoliter",
                                              "ci.lower.mean.total.vol.intake.nanoliter", "ci.upper.mean.total.vol.intake.nanoliter",
                                              "average.total.vol.intake.nanoliter.ci.lb", "average.total.vol.intake.nanoliter.ci.ub",
                                              "average.total.vol.intake.nanoliter.g", 1, 2)

plot.properties[["Feed Size per Fly (nl)"]] <- c("mean.vol.per.feed.nanoliter", "mean.vol.per.feed.per.fly.nanoliter",
                                    "ci.lower.vol.per.feed.per.fly.nanoliter", "ci.upper.vol.per.feed.per.fly.nanoliter",
                                    "average.vol.per.feed.per.fly.nanoliter.ci.lb", "average.vol.per.feed.per.fly.nanoliter.ci.ub",
                                    "average.vol.per.feed.per.fly.nanoliter.g", 0.25, 1)

plot.properties[["Feed Duration (s)"]] <- c("mean.feed.duration.s", "mean.feed.duration.s",
                                        "ci.lower.feed.duration.s", "ci.upper.feed.duration.s",
                                        "average.feed.duration.s.ci.lb", "average.feed.duration.s.ci.ub",
                                        "average.feed.duration.s.g", 0.2, 0.8)

plot.properties[["Feeding Speed per Fly (nl/s)"]] <- c("mean.feeding.speed.nl.per.s", "mean.feeding.speed.per.fly.nl.per.s",
                                        "ci.lower.feeding.speed.per.fly.nl.per.s", "ci.upper.feeding.speed.per.fly.nl.per.s",
                                        "average.feeding.speed.per.fly.nl.per.s.ci.lb", "average.feeding.speed.per.fly.nl.per.s.ci.ub",
                                        "average.feeding.speed.per.fly.nl.per.s.g", 0.01, 2.5)

for ( p in names(plot.properties) ) {
  plot.list <- list()
  for (c in contrast.columns) {
    range.plot <- range(summary.per.fly[ , plot.properties[[p]][1] ], na.rm = TRUE)
    ylim <- c( 0, max( 1.1 * range.plot) )
    
    # line-range plot with points
    plot.a <- ggplot() + 
      geom_dotplot(data = summary.per.fly, 
                   aes_string(x = "contrast.groups.withFoodType", 
                              y = plot.properties[[p]][1],
                              fill = "contrast.groups.withFoodType",
                              shape = "FoodType"),
                   binaxis = "y", 
                   alpha = 0.25,
                   method = "histodot",
                   binwidth = as.numeric(plot.properties[[p]][8]), # Change the size of the dot by changing the size of the bin.
                   stackdir = "center",
                   stackratio = 1, 
                   dotsize = as.numeric(plot.properties[[p]][9])) + 
      geom_pointrange(data = temp.summary.per.contrastGroup.withFood, 
                      aes_string(x = "contrast.groups.withFoodType", 
                                 y = plot.properties[[p]][2],
                                 colour = "contrast.groups.withFoodType",
                                 ymin = plot.properties[[p]][3],
                                 ymax = plot.properties[[p]][4]),
                      size = 4,
                      shape = "|",
                      alpha = 0.75) +
      contrastColours + contrastFills +
      guides( alpha = FALSE, size = FALSE, fill = FALSE, colour = FALSE, shape = FALSE) +
      coord_cartesian(ylim = ylim) +
      scale_y_continuous(
        #       breaks = seq(from = 0, to = ylim[2], by = 3),
        #       labels = seq(from = 0, to = ylim[2], by = 3),
        expand = c(0, 0.1)) + 
      ylab(p) + xlab("") + 
      theme_minimal() +
      theme( axis.text.x = element_text(size = 12),
             axis.title = element_text(size = 16, face = "plain"),
             axis.ticks.y = element_blank(),
             panel.grid.major.y = element_blank(),
             panel.grid.major.x = element_line(linetype = 3, colour = "black")) +
      coord_flip()
    
    legend <- get_legend(plot.a)

    plot.a <- plot.a + theme(legend.position = "none",
                             plot.title = element_text(size = 22),
                             axis.text.x = element_text(size = 12),
                             axis.title.y = element_text(size = 18),
                             plot.margin = unit(c(1,1,1,1), "lines") ) 
    
    # Hedges' g point-range plot
    temp.df <- droplevels(filter(hedges.g.withFood, fixed.factor == c))
    hedges.g.plot.y.low <- range( floor(na.exclude(temp.df[, plot.properties[[p]][5] ])) )[1]
    hedges.g.plot.y.high <- range( ceiling(na.exclude(temp.df[, plot.properties[[p]][6] ])) )[2]
    hedges.g.ylim <- c(hedges.g.plot.y.low, hedges.g.plot.y.high)
    
    
    plot.b <- ggplot(data = temp.df,
                     aes_string(x = "fixed.factor.level",
                                y = plot.properties[[p]][7] )) +
      geom_hline(yintercept = 0, 
                 linetype = 3,
                 alpha = 0.5,
                 size = 1) +
      geom_pointrange(aes_string(ymin = plot.properties[[p]][5],
                                 ymax = plot.properties[[p]][6],
                                 colour = "contrast.group.2"),
                      position = position_dodge(width = 0.8),
                      width = 1,
                      size = 1) +
      contrastColours + contrastFills +
      ylab("Hedges' g") + xlab("") + 
      coord_cartesian(ylim = hedges.g.ylim) + 
      geom_vline(xintercept = seq(1, length(reflevels[[c]]), 2) + 0.5,
                 color = "black") + # Adds dividing lines between contrasts.
      guides(size = FALSE,
             colour = FALSE ) +
      theme(legend.position = "none",
            axis.text.x = element_text(size = 12),
            axis.title.y = element_text(size = 18),
            plot.margin = unit(c(1,1,1,1), "lines") )
    
#     if (p == "Time To First Feed (s)") {
#       plot.a <- plot.a + scale_y_continuous(
#         breaks = seq(from = ylim[1], to = ylim[2], by = 3600),
#         labels = seq(from = ylim[1], to = ylim[2], by = 3600) / 3600)
#     } 
#     
#     if (p == "Feed Duration (s)") {
#       plot.a <- plot.a + scale_y_continuous(
#         breaks = seq(from = ylim[1], to = ylim[2], by = 1000),
#         labels = seq(from = ylim[1], to = ylim[2], by = 1000) / 1000)
#     } 
    
    plot.list[[c]] <- plot_grid(plot.a, plot.b,
                                ncol = 1, nrow = 2,
                                rel_heights = c(3, 1.2) )
  }
  
  plot.list[["legend"]] <- legend
  print(plot_grid(plotlist = plot.list,
                  labels = c(LETTERS[1: length(plot.list)-1], ""),
                  ncol = 2, 
                  nrow = length(plot.list)/2) ) 
}

```

\newpage

# Conclusions and Future Directions

*Write down your conclusions and future directions here.*

